<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÂàÜÊï∞„Ç¨„É≥„Éû„É≥ ü§†</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{--bg:#1c1008;--sand:#d4a654;--leather:#8b5e3c;--wood:#6b3a1f;--gold:#f0c040;--accent:#c0392b;--success:#27ae60;--text:#f5e6d0;--text-dim:#a08060;--rope:#c8a060;}
  body{font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;}
  .game-container{width:100vw;height:100vh;display:flex;flex-direction:column;align-items:center;position:relative;overflow:hidden;background:linear-gradient(180deg,#1c1008 0%,#2a1a0e 40%,#3a2510 70%,#1c1008 100%);}
  .bg-particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;}
  .bg-particle{position:absolute;border-radius:50%;animation:dust-drift 10s ease-in-out infinite;}
  @keyframes dust-drift{0%{transform:translate(0,0) scale(1);opacity:0.08}25%{transform:translate(30px,-15px) scale(1.2);opacity:0.15}50%{transform:translate(-10px,10px) scale(0.8);opacity:0.06}75%{transform:translate(20px,5px) scale(1.1);opacity:0.12}100%{transform:translate(0,0) scale(1);opacity:0.08}}
  .header{z-index:10;display:flex;align-items:center;justify-content:space-between;width:100%;max-width:700px;padding:12px 20px 4px;gap:8px;border-bottom:1px solid rgba(200,160,96,0.15);}
  .diff-badge{padding:3px 12px;border-radius:8px;font-size:0.7rem;font-weight:900;border:1px solid;}
  .diff-badge.easy{background:rgba(39,174,96,0.2);color:#5ddf70;border-color:rgba(39,174,96,0.4);}
  .diff-badge.normal{background:rgba(240,192,64,0.2);color:var(--gold);border-color:rgba(240,192,64,0.4);}
  .diff-badge.hard{background:rgba(192,57,43,0.2);color:#e74c3c;border-color:rgba(192,57,43,0.4);}
  .score-display{display:flex;align-items:center;gap:6px;font-size:1.1rem;font-weight:700;}
  .score-display .star{color:var(--gold);font-size:1.2rem;}
  .combo-display{font-size:0.85rem;color:var(--gold);font-weight:700;opacity:0;transition:opacity 0.3s;}
  .combo-display.active{opacity:1;animation:combo-pulse 0.4s ease;}
  @keyframes combo-pulse{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
  .quit-btn{background:none;border:1.5px solid rgba(200,160,96,0.25);color:var(--text-dim);padding:3px 10px;border-radius:8px;font-size:0.65rem;font-weight:700;cursor:pointer;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;white-space:nowrap;}
  .quit-btn:hover{border-color:var(--accent);color:var(--accent);}
  .timer-area{width:100%;max-width:700px;padding:4px 20px;z-index:10;display:flex;align-items:center;gap:10px;}
  .timer-bar-track{flex:1;height:12px;background:rgba(200,160,96,0.1);border-radius:6px;overflow:hidden;border:1px solid rgba(200,160,96,0.15);}
  .timer-bar-fill{height:100%;border-radius:5px;transition:width 0.15s linear,background 0.3s;background:linear-gradient(90deg,var(--sand),var(--gold));}
  .timer-bar-fill.danger{background:linear-gradient(90deg,var(--accent),#e74c3c);}
  .timer-bar-fill.progress{background:linear-gradient(90deg,var(--leather),var(--sand));}
  .timer-text{font-size:1.2rem;font-weight:900;min-width:52px;text-align:right;font-variant-numeric:tabular-nums;color:var(--sand);}
  .timer-text.danger{color:var(--accent);}
  .time-bonus-float{position:fixed;font-size:1.2rem;font-weight:900;color:var(--gold);pointer-events:none;z-index:200;animation:time-bonus-up 1s ease-out forwards;text-shadow:0 0 10px rgba(240,192,64,0.7);}
  @keyframes time-bonus-up{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-50px) scale(1.3)}}
  .countdown-num{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8rem;font-weight:900;color:var(--accent);pointer-events:none;z-index:180;text-shadow:0 0 40px rgba(192,57,43,0.6),0 0 80px rgba(192,57,43,0.3);animation:countdown-pop 0.9s ease-out forwards;}
  @keyframes countdown-pop{0%{opacity:0;transform:translate(-50%,-50%) scale(2.5)}15%{opacity:0.9;transform:translate(-50%,-50%) scale(1)}50%{opacity:0.7;transform:translate(-50%,-50%) scale(1.05)}100%{opacity:0;transform:translate(-50%,-50%) scale(0.6)}}
  .screen-flash{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:170;animation:flash-red 0.3s ease-out forwards;}
  @keyframes flash-red{0%{background:rgba(192,57,43,0.15)}100%{background:rgba(192,57,43,0)}}
  .timer-text.countdown-pulse{animation:timer-throb 0.4s ease;}
  @keyframes timer-throb{0%{transform:scale(1)}30%{transform:scale(1.5);color:var(--accent)}100%{transform:scale(1)}}
  .play-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;gap:12px;padding:0 20px;width:100%;max-width:700px;}
  .question-text{font-size:1.05rem;font-weight:700;text-align:center;color:var(--text-dim);}
  .pie-wrapper{position:relative;width:210px;height:210px;display:flex;align-items:center;justify-content:center;}
  .pie-chart{width:190px;height:190px;border-radius:50%;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.6),0 0 20px rgba(200,160,96,0.08),inset 0 0 20px rgba(0,0,0,0.3);overflow:hidden;transition:transform 0.15s ease;border:3px solid rgba(200,160,96,0.3);}
  .pie-chart canvas{width:100%;height:100%;}
  .shatter-container{position:absolute;top:0;left:0;width:210px;height:210px;pointer-events:none;z-index:50;}
  .shard{position:absolute;opacity:1;}
  @keyframes shard-fly{0%{opacity:1;transform:translate(0,0) rotate(0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) rotate(var(--rot)) scale(0.2)}}
  .sparkle-burst{position:absolute;top:50%;left:50%;pointer-events:none;z-index:51;}
  .sparkle{position:absolute;border-radius:50%;animation:sparkle-fly 0.7s ease-out forwards;}
  @keyframes sparkle-fly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--sx),var(--sy)) scale(0)}}
  @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
  .pie-chart.shake{animation:shake 0.4s ease;}
  .gray-flash{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:170;animation:flash-gray 0.4s ease-out forwards;}
  @keyframes flash-gray{0%{background:rgba(150,150,150,0.35)}100%{background:rgba(150,150,150,0)}}
  .pie-chart.entering{animation:pie-enter 0.2s ease-out;}
  @keyframes pie-enter{0%{transform:scale(0.3) rotate(-20deg);opacity:0}100%{transform:scale(1) rotate(0);opacity:1}}
  .cards-area{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;z-index:10;padding:6px 16px 24px;width:100%;max-width:700px;}
  .fraction-card{background:linear-gradient(145deg,#3a2410,#4a3018);border:2px solid #6b4a2a;border-radius:10px;padding:10px 16px;cursor:pointer;transition:transform 0.15s,box-shadow 0.2s,border-color 0.2s,background 0.2s;display:flex;flex-direction:column;align-items:center;min-width:62px;position:relative;box-shadow:0 3px 10px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05);}
  .fraction-card:hover:not(.disabled){border-color:var(--gold);box-shadow:0 0 15px rgba(240,192,64,0.3),0 4px 15px rgba(0,0,0,0.5);transform:translateY(-3px) scale(1.04);background:linear-gradient(145deg,#4a3018,#5a3820);}
  .fraction-card:active:not(.disabled){transform:scale(0.93);}
  .fraction-card.disabled{opacity:0.2;pointer-events:none;border-color:#333;box-shadow:none;}
  .fraction-card .numerator{font-size:1.4rem;font-weight:900;color:var(--gold);line-height:1;}
  .fraction-card .fraction-bar{width:32px;height:3px;background:var(--rope);margin:3px 0;border-radius:2px;}
  .fraction-card .denominator{font-size:1.4rem;font-weight:900;color:var(--sand);line-height:1;}
  .screen-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,8,2,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;gap:14px;backdrop-filter:blur(10px);overflow-y:auto;}
  .screen-overlay.hidden{display:none;}
  .screen-title{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#e8a020,var(--sand));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;line-height:1.3;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));}
  .screen-subtitle{font-size:0.95rem;color:var(--text-dim);text-align:center;max-width:360px;line-height:1.7;}
  .mode-tabs{display:flex;gap:0;margin-bottom:4px;border-radius:10px;overflow:hidden;border:2px solid rgba(200,160,96,0.2);}
  .mode-tab{padding:10px 28px;font-size:0.95rem;font-weight:900;cursor:pointer;border:none;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;background:rgba(200,160,96,0.05);color:var(--text-dim);}
  .mode-tab.active{color:var(--text);}
  .mode-tab.active.t-normal{background:linear-gradient(135deg,var(--leather),#6b4a2a);}
  .mode-tab.active.t-gunman{background:linear-gradient(135deg,var(--accent),#a0301f);}
  .mode-tab.active.t-battle{background:linear-gradient(135deg,#8e44ad,#6c3483);}
  .mode-desc{font-size:0.75rem;color:var(--text-dim);text-align:center;max-width:320px;margin-bottom:2px;}
  .diff-buttons{display:flex;gap:12px;margin-top:6px;flex-wrap:wrap;justify-content:center;}
  .diff-btn{border:2px solid;padding:14px 28px;border-radius:10px;font-size:1rem;font-weight:900;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:110px;box-shadow:0 4px 15px rgba(0,0,0,0.4);}
  .diff-btn:hover{transform:translateY(-3px) scale(1.05);}
  .diff-btn:active{transform:scale(0.96);}
  .diff-btn .diff-label{font-size:1.1rem;} .diff-btn .diff-desc{font-size:0.65rem;opacity:0.8;}
  .diff-btn.easy{background:linear-gradient(135deg,#2a6b3a,#1e5a2e);color:#7ddf90;border-color:#3a8b4a;}
  .diff-btn.normal{background:linear-gradient(135deg,#6b5020,#5a4018);color:var(--gold);border-color:var(--sand);}
  .diff-btn.hard{background:linear-gradient(135deg,#6b1a10,#5a1510);color:#ff8070;border-color:#8b3020;}
  .btn{background:linear-gradient(135deg,var(--leather),var(--wood));color:var(--text);border:2px solid var(--rope);padding:14px 40px;border-radius:12px;font-size:1.15rem;font-weight:900;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 6px 20px rgba(0,0,0,0.4);margin-top:4px;}
  .btn:hover{transform:translateY(-2px) scale(1.04);} .btn:active{transform:scale(0.97);}
  .result-popup{position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);font-size:2rem;font-weight:900;z-index:100;pointer-events:none;opacity:0;white-space:nowrap;}
  .result-popup.correct{color:var(--gold);animation:popup-correct 0.9s ease forwards;text-shadow:0 0 20px rgba(240,192,64,0.5);}
  .result-popup.wrong{color:var(--accent);animation:popup-wrong 0.7s ease forwards;}
  @keyframes popup-correct{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}15%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}45%{opacity:1;transform:translate(-50%,-60%) scale(1)}100%{opacity:0;transform:translate(-50%,-80%) scale(0.8)}}
  @keyframes popup-wrong{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}70%{opacity:1}100%{opacity:0}}
  .final-stats{display:flex;gap:24px;margin:6px 0;} .stat-item{text-align:center;}
  .stat-value{font-size:1.8rem;font-weight:900;color:var(--gold);}
  .stat-label{font-size:0.75rem;color:var(--text-dim);margin-top:2px;}
  .name-entry-form{display:flex;flex-direction:column;align-items:center;gap:10px;}
  .name-input{background:rgba(200,160,96,0.08);border:2px solid rgba(200,160,96,0.25);border-radius:10px;padding:8px 14px;font-size:1rem;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;color:var(--text);outline:none;width:180px;text-align:center;}
  .name-input:focus{border-color:var(--gold);} .name-input::placeholder{color:rgba(200,160,96,0.3);}
  .grade-selector{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
  .grade-btn{padding:5px 12px;border-radius:8px;border:2px solid rgba(200,160,96,0.2);background:rgba(200,160,96,0.05);color:var(--text-dim);font-size:0.75rem;font-weight:700;cursor:pointer;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.15s;}
  .grade-btn:hover{border-color:rgba(200,160,96,0.4);color:var(--sand);}
  .grade-btn.selected{border-color:var(--gold);color:var(--gold);background:rgba(240,192,64,0.1);box-shadow:0 0 10px rgba(240,192,64,0.15);}
  .ranking-btn-big{background:linear-gradient(135deg,rgba(240,192,64,0.15),rgba(240,192,64,0.05));border:2px solid var(--gold);color:var(--gold);padding:12px 28px;border-radius:12px;font-size:1rem;font-weight:900;cursor:pointer;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;box-shadow:0 0 15px rgba(240,192,64,0.1);animation:ranking-glow 2s ease-in-out infinite alternate;}
  .ranking-btn-big:hover{transform:translateY(-2px) scale(1.04);box-shadow:0 0 25px rgba(240,192,64,0.25);}
  @keyframes ranking-glow{0%{box-shadow:0 0 10px rgba(240,192,64,0.08)}100%{box-shadow:0 0 20px rgba(240,192,64,0.2)}}
  .ranking-btn{background:none;border:2px solid rgba(200,160,96,0.2);color:var(--text-dim);padding:7px 18px;border-radius:10px;font-size:0.8rem;font-weight:700;cursor:pointer;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;}
  .ranking-btn:hover{border-color:var(--gold);color:var(--gold);}
  .ranking-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,8,2,0.96);backdrop-filter:blur(10px);display:flex;flex-direction:column;align-items:center;z-index:250;gap:8px;overflow-y:auto;padding:20px 0;}
  .ranking-overlay.hidden{display:none;}
  .ranking-period-tabs{display:flex;gap:0;border-radius:10px;overflow:hidden;border:2px solid rgba(200,160,96,0.2);margin-bottom:2px;}
  .ranking-period-tab{padding:8px 20px;font-size:0.8rem;font-weight:900;cursor:pointer;border:none;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;background:rgba(200,160,96,0.05);color:var(--text-dim);}
  .ranking-period-tab.active.t-weekly{color:#ff9040;background:linear-gradient(135deg,rgba(255,144,64,0.2),rgba(192,57,43,0.15));border-color:rgba(255,144,64,0.3);}
  .ranking-period-tab.active.t-alltime{color:var(--gold);background:linear-gradient(135deg,rgba(240,192,64,0.2),rgba(200,160,96,0.15));border-color:rgba(240,192,64,0.3);}
  .ranking-mode-tabs{display:flex;gap:0;border-radius:10px;overflow:hidden;border:2px solid rgba(200,160,96,0.15);}
  .ranking-mode-tab{padding:6px 20px;font-size:0.8rem;font-weight:900;cursor:pointer;border:none;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;transition:all 0.2s;background:rgba(200,160,96,0.05);color:var(--text-dim);}
  .ranking-mode-tab.active{color:var(--text);background:linear-gradient(135deg,var(--leather),#6b4a2a);}
  .ranking-tabs{display:flex;gap:8px;}
  .ranking-tab{padding:6px 18px;border-radius:8px;border:1px solid rgba(200,160,96,0.15);font-size:0.9rem;font-weight:900;cursor:pointer;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;background:rgba(200,160,96,0.05);color:var(--text-dim);transition:all 0.2s;}
  .ranking-tab.active{color:var(--text);}
  .ranking-tab.active.t-easy{background:rgba(39,174,96,0.25);border-color:rgba(39,174,96,0.4);color:#7ddf90;}
  .ranking-tab.active.t-normal{background:rgba(240,192,64,0.2);border-color:rgba(240,192,64,0.4);color:var(--gold);}
  .ranking-tab.active.t-hard{background:rgba(192,57,43,0.25);border-color:rgba(192,57,43,0.4);color:#ff8070;}
  .ranking-reset-info{font-size:0.65rem;color:var(--text-dim);opacity:0.6;text-align:center;}
  .ranking-list{width:320px;max-width:90vw;}
  .ranking-entry{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;margin-bottom:5px;background:rgba(200,160,96,0.04);border:1px solid rgba(200,160,96,0.08);}
  .ranking-entry.highlight{background:rgba(240,192,64,0.1);border-color:rgba(240,192,64,0.3);}
  .ranking-rank{font-size:1.2rem;font-weight:900;min-width:32px;text-align:center;}
  .ranking-rank.r1{color:var(--gold);} .ranking-rank.r2{color:#c0c0c0;} .ranking-rank.r3{color:#cd7f32;}
  .ranking-name{flex:1;font-weight:700;font-size:0.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .ranking-score{font-weight:900;font-size:1rem;color:var(--gold);}
  .ranking-detail{font-size:0.65rem;color:var(--text-dim);}
  .ranking-empty{text-align:center;color:var(--text-dim);padding:24px 0;font-size:0.9rem;}
  .ranking-grade{font-size:0.6rem;padding:1px 6px;border-radius:6px;background:rgba(200,160,96,0.1);color:var(--text-dim);margin-left:4px;vertical-align:middle;}
  .new-record-badge{color:var(--gold);font-size:0.9rem;font-weight:700;animation:nr-glow 1s ease-in-out infinite alternate;}
  @keyframes nr-glow{0%{text-shadow:0 0 5px rgba(240,192,64,0.3)}100%{text-shadow:0 0 15px rgba(240,192,64,0.7)}}
  .ranking-date{font-size:0.55rem;color:rgba(200,160,96,0.35);margin-top:1px;}
  .ranking-arrow{font-size:0.7rem;margin-left:3px;}
  .ranking-arrow.up{color:var(--success);}
  .ranking-arrow.down{color:var(--accent);}
  .ranking-arrow.same{color:var(--text-dim);opacity:0.4;}
  .ranking-best{font-size:0.8rem;color:var(--text-dim);padding:4px 0;text-align:center;}
  .ranking-gap{font-size:0.75rem;color:var(--text-dim);text-align:center;padding:2px 0;}
  /* Mini ranking in result */
  .mini-ranking{width:280px;max-width:90vw;margin:4px 0;}
  .mini-ranking-title{font-size:0.75rem;font-weight:900;color:var(--sand);text-align:center;margin-bottom:4px;}
  .mini-entry{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:6px;font-size:0.8rem;background:rgba(200,160,96,0.04);border:1px solid rgba(200,160,96,0.06);margin-bottom:3px;}
  .mini-entry.highlight{background:rgba(240,192,64,0.1);border-color:rgba(240,192,64,0.3);}
  .mini-rank{font-weight:900;min-width:24px;text-align:center;}
  .mini-rank.r1{color:var(--gold);} .mini-rank.r2{color:#c0c0c0;} .mini-rank.r3{color:#cd7f32;}
  .mini-name{flex:1;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .mini-score{font-weight:900;color:var(--gold);}
  @media(max-width:500px){.pie-wrapper{width:170px;height:170px;}.pie-chart{width:155px;height:155px;}.fraction-card{padding:8px 12px;min-width:56px;}.fraction-card .numerator,.fraction-card .denominator{font-size:1.2rem;}.screen-title{font-size:1.7rem;}.diff-btn{min-width:90px;padding:12px 20px;}.mode-tab{padding:8px 20px;font-size:0.85rem;}}
  @media(max-height:650px){.pie-wrapper{width:150px;height:150px;}.pie-chart{width:135px;height:135px;}.play-area{gap:6px;}.cards-area{padding-bottom:12px;gap:8px;}}

  /* Tablet (768px+) */
  @media(min-width:768px){
    .header{max-width:900px;padding:16px 32px 6px;gap:12px;}
    .diff-badge{font-size:0.8rem;padding:4px 16px;}
    .score-display{font-size:1.3rem;} .score-display .star{font-size:1.4rem;}
    .combo-display{font-size:1rem;}
    .quit-btn{font-size:0.75rem;padding:5px 14px;}
    .timer-area{max-width:900px;padding:6px 32px;}
    .timer-bar-track{height:16px;border-radius:8px;}
    .timer-text{font-size:1.4rem;min-width:64px;}
    .play-area{max-width:900px;gap:18px;}
    .question-text{font-size:1.25rem;}
    .pie-wrapper{width:280px;height:280px;}
    .pie-chart{width:260px;height:260px;border-width:4px;}
    .shatter-container{width:280px;height:280px;}
    .cards-area{max-width:900px;gap:14px;padding:10px 32px 32px;}
    .fraction-card{padding:14px 22px;min-width:80px;min-height:56px;border-radius:12px;border-width:3px;}
    .fraction-card .numerator,.fraction-card .denominator{font-size:1.8rem;}
    .fraction-card .fraction-bar{width:40px;height:4px;margin:4px 0;}
    .screen-overlay{gap:18px;}
    .screen-title{font-size:2.8rem;}
    .screen-subtitle{font-size:1.1rem;max-width:480px;}
    .mode-tabs{border-radius:14px;}
    .mode-tab{padding:14px 36px;font-size:1.1rem;}
    .mode-desc{font-size:0.9rem;max-width:420px;}
    .diff-buttons{gap:16px;margin-top:10px;}
    .diff-btn{padding:18px 34px;border-radius:14px;min-width:140px;}
    .diff-btn .diff-label{font-size:1.3rem;}
    .diff-btn .diff-desc{font-size:0.75rem;}
    .btn{padding:16px 48px;font-size:1.25rem;border-radius:14px;}
    .ranking-btn-big{padding:14px 34px;font-size:1.1rem;border-radius:14px;}
    .ranking-btn{padding:9px 22px;font-size:0.9rem;}
    .final-stats{gap:36px;margin:10px 0;}
    .stat-value{font-size:2.2rem;}
    .stat-label{font-size:0.85rem;}
    .ranking-list{width:400px;}
    .ranking-entry{padding:12px 18px;border-radius:10px;margin-bottom:6px;}
    .ranking-rank{font-size:1.4rem;min-width:40px;}
    .ranking-name{font-size:1rem;}
    .ranking-score{font-size:1.2rem;}
    .ranking-detail{font-size:0.75rem;}
    .ranking-tabs{gap:10px;}
    .ranking-tab{padding:8px 20px;font-size:0.9rem;}
    .name-input{width:220px;font-size:1.1rem;padding:10px 16px;}
    .grade-selector{gap:8px;}
    .grade-btn{padding:7px 16px;font-size:0.85rem;}
    .result-popup{font-size:2.5rem;}
    .bang-text{font-size:5rem;}
    .draw-text span{font-size:3.5rem;}
    .draw-text .draw-sub{font-size:1.1rem;}
    .countdown-num{font-size:10rem;}
    .alt-badge-fixed{font-size:1.1rem;padding:8px 18px;border-radius:14px;top:16px;right:20px;}
    .alt-badge-fixed .alt-icon{font-size:1.3rem;}
    .alt-result{gap:4px;margin:8px 0;}
    .alt-earned{font-size:1.7rem;}
    .alt-stars{font-size:1.8rem;letter-spacing:6px;}
    .alt-breakdown{font-size:0.8rem;}
    .alt-total{font-size:1rem;}
    .desert-silhouette{height:160px;}
    .time-bonus-float{font-size:1.4rem;}
    .time-penalty-float{font-size:1.5rem;}
    .alt-float{font-size:1.4rem;}
    .tumbleweed{font-size:3.2rem;}
  }

  /* Large tablet / landscape (1024px+) */
  @media(min-width:1024px){
    .header{max-width:1000px;}
    .timer-area{max-width:1000px;}
    .play-area{max-width:1000px;}
    .cards-area{max-width:1000px;gap:16px;}
    .pie-wrapper{width:320px;height:320px;}
    .pie-chart{width:300px;height:300px;}
    .shatter-container{width:320px;height:320px;}
    .fraction-card{padding:16px 26px;min-width:90px;}
    .fraction-card .numerator,.fraction-card .denominator{font-size:2rem;}
    .fraction-card .fraction-bar{width:46px;}
    .screen-title{font-size:3.2rem;}
    .ranking-list{width:460px;}
  }

  /* ===== Tablet Landscape Optimization ===== */
  @media(min-width:768px) and (orientation:landscape){
    .header{max-width:100%;padding:10px 32px 4px;}
    .timer-area{max-width:100%;padding:4px 32px;}
    .play-area{flex-direction:row;max-width:100%;gap:24px;padding:0 32px;justify-content:center;align-items:center;}
    .cards-area{display:grid;grid-template-columns:repeat(3,1fr);max-width:none;width:auto;flex:0 0 auto;gap:12px;padding:0;align-content:center;}
    .pie-wrapper{flex-shrink:0;}
    .question-text{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:1rem;}
    .play-area{position:relative;padding-top:32px;}
    .fraction-card{min-width:70px;min-height:56px;justify-content:center;}
    /* Start screen landscape 2-column */
    #startScreen{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto 1fr auto;gap:8px 24px;padding:24px 40px;align-content:center;justify-items:center;}
    #startScreen .screen-title{grid-column:1/3;}
    #startScreen .screen-subtitle{grid-column:1/3;}
    #startScreen .mode-tabs{grid-column:1;grid-row:3;align-self:start;}
    #startScreen .mode-desc{grid-column:1;grid-row:3;align-self:center;margin-top:60px;}
    #startScreen .diff-buttons{grid-column:2;grid-row:3;align-self:center;flex-direction:column;}
    #startScreen .ranking-btn-big{grid-column:1;grid-row:4;}
    /* Game over landscape 2-column */
    #gameOverScreen{display:grid;grid-template-columns:1fr 1fr;gap:6px 24px;padding:20px 40px;align-content:center;justify-items:center;}
    #gameOverScreen .screen-title{grid-column:1/3;}
    #gameOverScreen .final-stats{grid-column:1;}
    #gameOverScreen .alt-result{grid-column:1;}
    #gameOverScreen .mini-ranking{grid-column:2;grid-row:2/5;}
    #gameOverScreen .ranking-gap{grid-column:2;}
    #gameOverScreen .mode-tabs{grid-column:1/3;}
    #gameOverScreen .diff-buttons{grid-column:1/3;}
    #gameOverScreen .btn{grid-column:1/3;}
  }
  @media(min-width:1024px) and (orientation:landscape){
    .cards-area{grid-template-columns:repeat(3,1fr);gap:14px;}
    .fraction-card{min-width:85px;min-height:60px;padding:14px 24px;}
    .play-area{gap:36px;}
  }

  /* ===== Battle Mode Styles ===== */
  .battle-container{position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(180deg,#1c1008 0%,#2a1a0e 40%,#3a2510 70%,#1c1008 100%);display:flex;flex-direction:column;z-index:100;overflow:hidden;}
  .battle-container.hidden{display:none;}
  .battle-side{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 12px;position:relative;min-height:0;}
  .battle-side.p2{transform:rotate(180deg);}
  .battle-header{display:flex;align-items:center;justify-content:center;gap:12px;padding:4px 12px;width:100%;max-width:500px;}
  .battle-player-label{font-size:0.85rem;font-weight:900;padding:3px 12px;border-radius:8px;border:2px solid;}
  .battle-player-label.p1-label{background:rgba(52,152,219,0.2);color:#5dade2;border-color:rgba(52,152,219,0.4);}
  .battle-player-label.p2-label{background:rgba(192,57,43,0.2);color:#e74c3c;border-color:rgba(192,57,43,0.4);}
  .battle-score{font-size:1.2rem;font-weight:900;color:var(--gold);display:flex;align-items:center;gap:4px;}
  .battle-combo{font-size:0.8rem;font-weight:700;color:var(--gold);opacity:0;transition:opacity 0.3s;}
  .battle-combo.active{opacity:1;}
  .battle-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:400px;padding:4px;}
  .battle-cards .fraction-card{min-height:48px;padding:8px 10px;}
  .battle-cards .fraction-card .numerator,.battle-cards .fraction-card .denominator{font-size:1.2rem;}
  .battle-cards .fraction-card .fraction-bar{width:28px;height:2px;margin:2px 0;}
  .battle-center{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px 0;position:relative;z-index:10;flex-shrink:0;}
  .battle-divider{width:90%;height:2px;background:linear-gradient(90deg,transparent,rgba(200,160,96,0.3),var(--gold),rgba(200,160,96,0.3),transparent);margin:2px 0;}
  .battle-pies{display:flex;flex-direction:row;align-items:center;justify-content:center;gap:8px;}
  .battle-pie-center-info{display:flex;flex-direction:column;align-items:center;gap:2px;}
  .battle-vs{font-size:1rem;font-weight:900;color:var(--gold);text-shadow:0 0 15px rgba(240,192,64,0.5);letter-spacing:4px;}
  .battle-pie-wrapper{width:120px;height:120px;display:flex;align-items:center;justify-content:center;position:relative;}
  .battle-pie-wrapper .pie-chart{width:110px;height:110px;}
  .battle-pie-wrapper .shatter-container{width:120px;height:120px;}
  .battle-round{font-size:0.75rem;color:var(--text-dim);font-weight:700;}
  .battle-flash{position:absolute;top:0;left:0;width:100%;height:50%;pointer-events:none;z-index:20;}
  .battle-flash.p1{bottom:0;top:auto;}
  .battle-flash.correct{animation:battle-flash-correct 0.4s ease-out forwards;}
  .battle-flash.wrong{animation:battle-flash-wrong 0.4s ease-out forwards;}
  @keyframes battle-flash-correct{0%{background:rgba(52,152,219,0.2)}100%{background:transparent}}
  @keyframes battle-flash-wrong{0%{background:rgba(192,57,43,0.2)}100%{background:transparent}}
  .battle-point-float{position:absolute;font-size:1.5rem;font-weight:900;pointer-events:none;z-index:30;animation:battle-point-up 0.8s ease-out forwards;}
  .battle-point-float.p1{color:#5dade2;bottom:50%;left:50%;transform:translateX(-50%);}
  .battle-point-float.p2{color:#e74c3c;top:50%;left:50%;transform:translateX(-50%) rotate(180deg);}
  @keyframes battle-point-up{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-40px) scale(1.3)}}
  .battle-result-title{font-size:2rem;font-weight:900;text-align:center;line-height:1.3;}
  .battle-result-title.p1-win{background:linear-gradient(135deg,#3498db,#5dade2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .battle-result-title.p2-win{background:linear-gradient(135deg,#c0392b,#e74c3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .battle-result-title.draw-result{background:linear-gradient(135deg,var(--gold),var(--sand));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .battle-result-players{display:flex;gap:20px;margin:10px 0;justify-content:center;}
  .battle-result-card{text-align:center;padding:16px 24px;border-radius:12px;border:2px solid;min-width:140px;}
  .battle-result-card.p1{border-color:rgba(52,152,219,0.4);background:rgba(52,152,219,0.08);}
  .battle-result-card.p2{border-color:rgba(192,57,43,0.4);background:rgba(192,57,43,0.08);}
  .battle-result-card.winner{box-shadow:0 0 20px rgba(240,192,64,0.3);border-color:var(--gold);}
  .battle-result-label{font-size:0.8rem;font-weight:900;margin-bottom:6px;}
  .battle-result-card.p1 .battle-result-label{color:#5dade2;}
  .battle-result-card.p2 .battle-result-label{color:#e74c3c;}
  .battle-result-score{font-size:2rem;font-weight:900;color:var(--gold);}
  .battle-result-detail{font-size:0.75rem;color:var(--text-dim);margin-top:4px;}
  .battle-result-crown{font-size:2.5rem;animation:crown-bounce 0.6s ease infinite alternate;}
  @keyframes crown-bounce{0%{transform:translateY(0) scale(1)}100%{transform:translateY(-6px) scale(1.1)}}
  #battleSetupScreen .battle-setup-desc{font-size:0.85rem;color:var(--text-dim);text-align:center;max-width:320px;line-height:1.6;}
  @media(min-width:768px){
    .battle-pies{gap:16px;}
    .battle-pie-wrapper{width:160px;height:160px;}
    .battle-pie-wrapper .pie-chart{width:148px;height:148px;}
    .battle-pie-wrapper .shatter-container{width:160px;height:160px;}
    .battle-cards{max-width:520px;gap:10px;}
    .battle-cards .fraction-card{min-height:56px;padding:10px 14px;}
    .battle-cards .fraction-card .numerator,.battle-cards .fraction-card .denominator{font-size:1.5rem;}
    .battle-cards .fraction-card .fraction-bar{width:34px;height:3px;}
    .battle-vs{font-size:1.3rem;}
    .battle-score{font-size:1.5rem;}
    .battle-result-title{font-size:2.5rem;}
    .battle-result-card{padding:20px 32px;min-width:180px;}
    .battle-result-score{font-size:2.5rem;}
  }
  @media(min-width:768px) and (orientation:landscape){
    .battle-pie-wrapper{width:130px;height:130px;}
    .battle-pie-wrapper .pie-chart{width:120px;height:120px;}
    .battle-pie-wrapper .shatter-container{width:130px;height:130px;}
    .battle-center{flex-direction:row;gap:16px;padding:4px 0;}
    .battle-pies{gap:12px;}
    .battle-cards{max-width:360px;}
    .battle-side{padding:4px 16px;}
  }

  /* Desert silhouette decoration */
  .desert-silhouette{position:fixed;bottom:0;left:0;width:100%;height:120px;pointer-events:none;z-index:1;opacity:0.12;}
  .desert-silhouette svg{width:100%;height:100%;}

  /* BANG effect */
  .bang-effect{position:fixed;top:38%;left:50%;transform:translate(-50%,-50%);z-index:150;pointer-events:none;animation:bang-pop 0.7s ease-out forwards;}
  .bang-text{font-size:4rem;font-weight:900;color:var(--accent);text-shadow:0 0 30px rgba(192,57,43,0.8),0 0 60px rgba(240,192,64,0.4),3px 3px 0 #1c1008;letter-spacing:4px;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;}
  @keyframes bang-pop{0%{opacity:0;transform:translate(-50%,-50%) scale(0.2) rotate(-10deg)}10%{opacity:1;transform:translate(-50%,-50%) scale(1.4) rotate(3deg)}30%{transform:translate(-50%,-50%) scale(1) rotate(-1deg)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.05) rotate(0)}100%{opacity:0;transform:translate(-50%,-50%) scale(0.8) rotate(0)}}

  /* Tumbleweed */
  .tumbleweed{position:fixed;bottom:15%;z-index:150;pointer-events:none;font-size:2.5rem;animation:tumble-roll 1.8s ease-in-out forwards;}
  @keyframes tumble-roll{0%{left:-60px;transform:rotate(0deg);opacity:0.8}30%{opacity:1}100%{left:110vw;transform:rotate(720deg);opacity:0}}

  /* DRAW timeout effect */
  .draw-overlay{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:160;animation:draw-dim 1.2s ease-out forwards;}
  @keyframes draw-dim{0%{background:rgba(0,0,0,0)}15%{background:rgba(0,0,0,0.5)}70%{background:rgba(0,0,0,0.4)}100%{background:rgba(0,0,0,0)}}
  .draw-text{position:fixed;top:42%;left:50%;transform:translate(-50%,-50%);z-index:161;pointer-events:none;animation:draw-appear 1.2s ease-out forwards;}
  .draw-text span{font-size:2.8rem;font-weight:900;color:#888;font-family:'M PLUS Rounded 1c','Zen Maru Gothic',sans-serif;text-shadow:0 2px 10px rgba(0,0,0,0.8);letter-spacing:6px;}
  .draw-text .draw-sub{display:block;font-size:0.9rem;color:var(--accent);letter-spacing:2px;margin-top:4px;text-align:center;}
  @keyframes draw-appear{0%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}10%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}30%{transform:translate(-50%,-50%) scale(1)}75%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(0.95)}}

  /* Time penalty float */
  .time-penalty-float{position:fixed;font-size:1.3rem;font-weight:900;color:var(--accent);pointer-events:none;z-index:200;animation:time-penalty-up 1.2s ease-out forwards;text-shadow:0 0 10px rgba(192,57,43,0.7);}
  @keyframes time-penalty-up{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-50px) scale(1.3)}}

  /* ALT badge (home screen, fixed top-right) */
  .alt-badge-fixed{position:fixed;top:12px;right:16px;z-index:300;display:flex;align-items:center;gap:5px;background:rgba(15,8,2,0.85);border:2px solid var(--gold);border-radius:12px;padding:6px 14px;font-size:0.95rem;font-weight:900;color:var(--gold);backdrop-filter:blur(6px);box-shadow:0 2px 12px rgba(240,192,64,0.15);}
  .alt-badge-fixed.hidden{display:none;}
  .alt-badge-fixed .alt-icon{font-size:1.1rem;}
  .alt-badge-fixed .alt-unit{font-size:0.65rem;color:var(--text-dim);margin-left:2px;}

  /* ALT float (correct answer) */
  .alt-float{position:fixed;font-size:1.2rem;font-weight:900;color:var(--success);pointer-events:none;z-index:200;animation:alt-float-up 0.9s ease-out forwards;text-shadow:0 0 10px rgba(39,174,96,0.6);}
  @keyframes alt-float-up{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-45px) scale(1.3)}}

  /* ALT result on game over */
  .alt-result{display:flex;flex-direction:column;align-items:center;gap:2px;margin:4px 0;}
  .alt-earned{font-size:1.4rem;font-weight:900;color:var(--success);}
  .alt-breakdown{font-size:0.7rem;color:var(--text-dim);}
  .alt-stars{font-size:1.5rem;letter-spacing:4px;}
  .alt-total{font-size:0.85rem;color:var(--text-dim);}
  .alt-first-clear{color:var(--gold);font-size:0.85rem;font-weight:900;animation:nr-glow 1s ease-in-out infinite alternate;}


  /* ===== TRAIL Integration Styles ===== */
  .trail-accent{color:#1a73e8;}
  .hidden-immediate{display:none!important;}
  .player-info{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
  .player-name-badge{background:linear-gradient(135deg,rgba(26,115,232,0.15),rgba(26,115,232,0.05));border:2px solid rgba(26,115,232,0.4);color:#5da6ff;padding:6px 16px;border-radius:12px;font-size:0.95rem;font-weight:700;display:flex;align-items:center;gap:6px;}
  .player-name-badge .player-icon{font-size:1.1rem;}
  .streak-badge{background:linear-gradient(135deg,rgba(240,192,64,0.15),rgba(240,192,64,0.05));border:2px solid rgba(240,192,64,0.3);color:var(--gold);padding:4px 12px;border-radius:10px;font-size:0.8rem;font-weight:700;}
  .trail-result-section{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 20px;border-radius:12px;background:rgba(26,115,232,0.06);border:1px solid rgba(26,115,232,0.15);margin:6px 0;}
  .trail-alt-popup{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;background:rgba(10,5,0,0.92);backdrop-filter:blur(10px);animation:trail-popup-in 0.4s ease;}
  .trail-alt-popup.hidden{display:none;}
  @keyframes trail-popup-in{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}
  .trail-alt-amount{font-size:3rem;font-weight:900;color:var(--gold);text-shadow:0 0 30px rgba(240,192,64,0.5);animation:trail-alt-bounce 0.6s ease;}
  @keyframes trail-alt-bounce{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
  .trail-alt-label{font-size:1rem;color:var(--text-dim);margin-top:4px;}


  @media(min-width:768px){
    .player-name-badge{font-size:1.1rem;padding:8px 20px;border-radius:14px;}
    .streak-badge{font-size:0.9rem;padding:5px 14px;}
    .trail-result-section{padding:16px 28px;}
    .trail-alt-amount{font-size:4rem;}
  }
</style>
</head>
<body>
<div class="game-container">
  <div class="bg-particles" id="bgParticles"></div>
  <!-- Desert silhouette -->
  <div class="desert-silhouette"><svg viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,120 L0,90 Q50,80 80,85 Q120,60 160,70 L180,72 Q200,30 220,65 L230,68 Q250,55 270,62 Q290,58 310,70 L350,72 Q380,65 400,75 Q430,50 460,68 Q480,40 500,60 L520,65 Q540,55 560,62 Q580,35 610,58 L640,62 Q670,20 700,55 Q720,48 740,58 L760,60 Q800,52 830,65 Q860,45 890,60 L920,62 Q950,50 980,60 Q1010,55 1040,68 Q1070,40 1100,60 Q1130,55 1160,65 L1200,70 L1200,120 Z" fill="#d4a654"/><ellipse cx="150" cy="50" rx="8" ry="35" fill="#d4a654"/><ellipse cx="150" cy="30" rx="15" ry="6" fill="#d4a654"/><ellipse cx="150" cy="45" rx="12" ry="5" fill="#d4a654"/><ellipse cx="850" cy="45" rx="7" ry="40" fill="#d4a654"/><ellipse cx="850" cy="20" rx="13" ry="5" fill="#d4a654"/><ellipse cx="850" cy="38" rx="11" ry="4" fill="#d4a654"/><ellipse cx="835" cy="55" rx="10" ry="4" fill="#d4a654"/></svg></div>
  <div class="screen-overlay hidden" id="startScreen">
    <div class="screen-title">ü§† ÂàÜÊï∞„Ç¨„É≥„Éû„É≥</div>
    <div class="player-info hidden" id="playerInfo">
      <div class="player-name-badge"><span class="player-icon">ü§†</span><span id="playerNameText">---</span></div>
      <div class="streak-badge hidden" id="streakBadge">üî• <span id="streakText">0</span> ÈÄ£Á∂ö</div>
    </div>
    <div class="screen-subtitle">ÂÜÜ„Ç∞„É©„Éï„Å´Âêà„ÅÜÂàÜÊï∞„Ç´„Éº„Éâ„Çí<br>„ÇØ„É™„ÉÉ„ÇØ‰∏ÄÁô∫„ÅßÊíÉ„Å°Êäú„ÅëÔºÅüí•</div>
    <div class="mode-tabs">
      <button class="mode-tab t-normal active" id="modeTabNormal" onclick="switchMode('normal')">üìù ÈÄöÂ∏∏</button>
      <button class="mode-tab t-gunman" id="modeTabGunman" onclick="switchMode('gunman')">üî´ „Ç¨„É≥„Éû„É≥</button>
      <button class="mode-tab t-battle" id="modeTabBattle" onclick="switchMode('battle')">‚öîÔ∏è ÂØæÊà¶</button>
    </div>
    <div class="mode-desc" id="modeDesc">10Âïè„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ„Åò„Å£„Åè„ÇäÊ≠£Á¢∫„Å´Á≠î„Åà„Çà„ÅÜ</div>
    <div style="color:var(--text-dim);font-size:0.9rem;font-weight:700;">Èõ£ÊòìÂ∫¶„Çí„Åà„Çâ„Åº„ÅÜ üåµ</div>
    <div class="diff-buttons">
      <button class="diff-btn easy" onclick="startGame('easy')"><span class="diff-label">üå± „Åã„Çì„Åü„Çì</span><span class="diff-desc">1/2, 1/3, 3/4 „Å™„Å©</span></button>
      <button class="diff-btn normal" onclick="startGame('normal')"><span class="diff-label">‚ö° „Åµ„Å§„ÅÜ</span><span class="diff-desc">2/5, 3/8, 7/10 „Å™„Å©</span></button>
      <button class="diff-btn hard" onclick="startGame('hard')"><span class="diff-label">üî• „ÇÄ„Åö„Åã„Åó„ÅÑ</span><span class="diff-desc">7/16, 11/20, Á¥ÑÂàÜ„ÇÇ</span></button>
    </div>
    <button class="ranking-btn-big" onclick="showRanking()">üèÜ üî´ „Ç¨„É≥„Éû„É≥„É©„É≥„Ç≠„É≥„Ç∞</button>
  </div>
  <!-- ALT badge fixed top-right (visible on home/overlays) -->
  <div class="alt-badge-fixed" id="altBadge"><span class="alt-icon">ü™ô</span><span id="altBadgeNum">0</span><span class="alt-unit">ALT</span></div>
  <div class="screen-overlay hidden" id="gameOverScreen">
    <div class="screen-title" id="gameOverTitle">üèúÔ∏è ÁµÇ‰∫ÜÔºÅ</div>
    <div class="final-stats">
      <div class="stat-item"><div class="stat-value" id="finalScore">0</div><div class="stat-label">„Çπ„Ç≥„Ç¢</div></div>
      <div class="stat-item"><div class="stat-value" id="finalCorrect">0</div><div class="stat-label">Ê≠£Ëß£Êï∞</div></div>
      <div class="stat-item"><div class="stat-value" id="finalCombo">0</div><div class="stat-label">ÊúÄÂ§ß„Ç≥„É≥„Éú</div></div>
    </div>
    <div class="stat-item"><div class="stat-value" style="font-size:1.1rem;" id="finalAccuracy">0%</div><div class="stat-label">Ê≠£Ëß£Áéá</div></div>
    <div class="stat-item" id="finalTimeRow" style="display:none;"><div class="stat-value" style="font-size:1.1rem;" id="finalTime">0.0Áßí</div><div class="stat-label">ÂêàË®à„Çø„Ç§„É†</div></div>
    <div class="alt-result">
      <div class="alt-stars" id="altStars"></div>
      <div class="alt-earned" id="altEarned"></div>
      <div style="font-size:1.1rem;font-weight:900;color:var(--sand);margin-top:2px;" id="altScore"></div>
      <div class="alt-breakdown" id="altBreakdown"></div>
      <div class="alt-first-clear hidden" id="altFirstClear">üåü Âàù„ÇØ„É™„Ç¢„Éú„Éº„Éä„Çπ +3 ALT!</div>
      <div class="alt-total" id="altTotal"></div>
    </div>
    <button class="ranking-btn-big" id="rankDetailBtn" onclick="showRanking(state.gameMode,state.mode)">üèÜ „É©„É≥„Ç≠„É≥„Ç∞Ë©≥Á¥∞</button>
    <button class="ranking-btn-big" id="registerRankBtn" style="background:linear-gradient(135deg,var(--leather),#6b4a2a);border-color:var(--rope);display:none;" onclick="startNameEntry()">üìù „É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åô„Çã</button>
    <div class="mini-ranking" id="miniRanking"></div>
    <div class="ranking-gap" id="rankGapText"></div>
    <div class="mode-tabs" style="margin-top:6px;">
      <button class="mode-tab t-normal" id="modeTabNormal2" onclick="switchMode('normal')">üìù ÈÄöÂ∏∏</button>
      <button class="mode-tab t-gunman" id="modeTabGunman2" onclick="switchMode('gunman')">üî´ „Ç¨„É≥„Éû„É≥</button>
    </div>
    <div class="diff-buttons" style="margin-top:4px;">
      <button class="diff-btn easy" onclick="startGame('easy')">üå± „Åã„Çì„Åü„Çì</button>
      <button class="diff-btn normal" onclick="startGame('normal')">‚ö° „Åµ„Å§„ÅÜ</button>
      <button class="diff-btn hard" onclick="startGame('hard')">üî• „ÇÄ„Åö„Åã„Åó„ÅÑ</button>
    </div>
    <button class="btn" style="margin-top:10px;padding:10px 30px;font-size:1rem;" onclick="goHome()">üè† „Éõ„Éº„É†„Å´Êàª„Çã</button>
  </div>
  <div class="ranking-overlay hidden" id="rankingOverlay">
    <div class="screen-title" style="font-size:1.6rem;">üèÜ üî´ „Ç¨„É≥„Éû„É≥„É©„É≥„Ç≠„É≥„Ç∞</div>
    <div class="ranking-period-tabs">
      <button class="ranking-period-tab t-weekly active" id="rankPeriodWeekly" onclick="switchRankPeriod('weekly')">üî• ÈÄ±Èñì</button>
      <button class="ranking-period-tab t-alltime" id="rankPeriodAlltime" onclick="switchRankPeriod('alltime')">üëë Ê∞∏‰πÖ</button>
    </div>
    <div class="ranking-tabs">
      <button class="ranking-tab t-easy active" onclick="switchRankDiff('easy')">üå±</button>
      <button class="ranking-tab t-normal" onclick="switchRankDiff('normal')">‚ö°</button>
      <button class="ranking-tab t-hard" onclick="switchRankDiff('hard')">üî•</button>
    </div>
    <div class="ranking-reset-info" id="rankResetInfo"></div>
    <div class="ranking-list" id="rankingList"></div>
    <div class="ranking-best" id="rankingBest"></div>
    <button class="btn" style="padding:10px 30px;font-size:1rem;" onclick="hideRanking()">„ÇÇ„Å©„Çã</button>
  </div>
  <div class="screen-overlay hidden" id="nameEntryOverlay" style="z-index:260;">
    <div class="screen-title" style="font-size:1.8rem;">üéâ „É©„É≥„Ç≠„É≥„Ç∞ÂÖ•„ÇäÔºÅ</div>
    <div id="nameEntryRankText" style="color:var(--gold);font-size:1.1rem;font-weight:900;"></div>
    <div id="nameEntryScoreText" style="color:var(--text-dim);font-size:0.9rem;"></div>
    <div style="color:var(--text-dim);font-size:0.95rem;margin-top:10px;">ÂêçÂâç„ÇíË®òÈå≤„Åô„ÇãÔºü</div>
    <div class="name-entry-form">
      <input class="name-input" id="nameEntryInput" type="text" placeholder="„Å™„Åæ„Åà" maxlength="8">
      <div class="grade-selector">
        <button class="grade-btn" data-grade="Â∞è1" onclick="selectGrade(this)">Â∞è1</button>
        <button class="grade-btn" data-grade="Â∞è2" onclick="selectGrade(this)">Â∞è2</button>
        <button class="grade-btn" data-grade="Â∞è3" onclick="selectGrade(this)">Â∞è3</button>
        <button class="grade-btn" data-grade="Â∞è4" onclick="selectGrade(this)">Â∞è4</button>
        <button class="grade-btn" data-grade="Â∞è5" onclick="selectGrade(this)">Â∞è5</button>
        <button class="grade-btn" data-grade="Â∞è6" onclick="selectGrade(this)">Â∞è6</button>
        <button class="grade-btn" data-grade="‰∏≠Â≠¶" onclick="selectGrade(this)">‰∏≠Â≠¶</button>
        <button class="grade-btn" data-grade="Â§ß‰∫∫" onclick="selectGrade(this)">Â§ß‰∫∫</button>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px;">
      <button class="btn" style="padding:10px 28px;font-size:0.95rem;background:linear-gradient(135deg,#2a6b3a,#1e5a2e);border-color:#3a8b4a;" onclick="confirmNameEntry()">ÁôªÈå≤„Åô„ÇãÔºÅ</button>
      <button class="ranking-btn" style="margin-top:0;padding:10px 20px;" onclick="skipNameEntry()">„Çπ„Ç≠„ÉÉ„Éó</button>
    </div>
  </div>
  <div class="header">
    <div class="diff-badge" id="diffBadge">„Åã„Çì„Åü„Çì</div>
    <div class="score-display"><span class="star">‚≠ê</span><span id="scoreText">0</span></div>
    <div class="combo-display" id="comboDisplay">üî• x0</div>
    <div style="font-size:0.8rem;color:var(--text-dim);" id="correctCount">Ê≠£Ëß£: 0</div>
    <button class="quit-btn" onclick="quitGame()">‚úï „ÇÑ„ÇÅ„Çã</button>
  </div>
  <div class="timer-area">
    <div class="timer-bar-track"><div class="timer-bar-fill" id="timerBarFill" style="width:100%"></div></div>
    <div class="timer-text" id="timerText">30.0</div>
  </div>
  <div class="play-area">
    <div class="question-text" id="questionText">„Åì„ÅÆÁöÑ„ÅÆÂàÜÊï∞„ÅØÔºüüéØ</div>
    <div class="pie-wrapper">
      <div class="pie-chart" id="pieChart"><canvas id="pieCanvas" width="400" height="400"></canvas></div>
      <div class="shatter-container" id="shatterContainer"></div>
      <div class="sparkle-burst" id="sparkleBurst"></div>
    </div>
  </div>
  <div class="cards-area" id="cardsArea"></div>
</div>
<!-- Battle Setup Screen -->
<div class="screen-overlay hidden" id="battleSetupScreen" style="z-index:210;">
  <div class="screen-title">‚öîÔ∏è Ê±∫Èóò„É¢„Éº„Éâ</div>
  <div class="battle-setup-desc">1Âè∞„ÅÆ„Çø„Éñ„É¨„ÉÉ„Éà„ÅßÂêë„Åã„ÅÑÂêà„Å£„Å¶ÂØæÊ±∫ÔºÅ<br>Âêå„ÅòÂïèÈ°å„Å´Êó©Êäº„Åó„ÅßÊåë„ÇÅÔºÅüí•</div>
  <div style="color:var(--text-dim);font-size:0.9rem;font-weight:700;margin-top:8px;">Èõ£ÊòìÂ∫¶„Çí„Åà„Çâ„Åº„ÅÜ üåµ</div>
  <div class="diff-buttons">
    <button class="diff-btn easy" onclick="startBattle('easy')"><span class="diff-label">üå± „Åã„Çì„Åü„Çì</span><span class="diff-desc">1/2, 1/3, 3/4 „Å™„Å©</span></button>
    <button class="diff-btn normal" onclick="startBattle('normal')"><span class="diff-label">‚ö° „Åµ„Å§„ÅÜ</span><span class="diff-desc">2/5, 3/8, 7/10 „Å™„Å©</span></button>
    <button class="diff-btn hard" onclick="startBattle('hard')"><span class="diff-label">üî• „ÇÄ„Åö„Åã„Åó„ÅÑ</span><span class="diff-desc">7/16, 11/20, Á¥ÑÂàÜ„ÇÇ</span></button>
  </div>
  <button class="btn" style="padding:10px 30px;font-size:1rem;" onclick="hideBattleSetup()">„ÇÇ„Å©„Çã</button>
</div>
<!-- Battle Container -->
<div class="battle-container hidden" id="battleContainer">
  <div class="battle-side p2" id="battleSideP2">
    <div class="battle-header">
      <span class="battle-player-label p2-label">P2</span>
      <div class="battle-score">‚≠ê <span id="battleP2Score">0</span></div>
      <div class="battle-combo" id="battleP2Combo">üî• x0</div>
    </div>
    <div class="battle-cards" id="p2Cards"></div>
  </div>
  <div class="battle-center">
    <div class="battle-divider"></div>
    <div class="battle-pies">
      <div class="battle-pie-wrapper p2-pie" style="transform:rotate(180deg);">
        <div class="pie-chart" id="battlePieChartP2"><canvas id="battlePieCanvasP2" width="400" height="400"></canvas></div>
        <div class="shatter-container" id="battleShatterContainerP2"></div>
      </div>
      <div class="battle-pie-center-info">
        <div class="battle-vs" id="battleVsText">VS</div>
        <div class="battle-round" id="battleRound">Round 1 / 10</div>
      </div>
      <div class="battle-pie-wrapper p1-pie">
        <div class="pie-chart" id="battlePieChart"><canvas id="battlePieCanvas" width="400" height="400"></canvas></div>
        <div class="shatter-container" id="battleShatterContainer"></div>
      </div>
    </div>
    <div class="battle-divider"></div>
  </div>
  <div class="battle-side p1" id="battleSideP1">
    <div class="battle-cards" id="p1Cards"></div>
    <div class="battle-header">
      <span class="battle-player-label p1-label">P1</span>
      <div class="battle-score">‚≠ê <span id="battleP1Score">0</span></div>
      <div class="battle-combo" id="battleP1Combo">üî• x0</div>
    </div>
  </div>
</div>
<!-- Battle Result Screen -->
<div class="screen-overlay hidden" id="battleResultScreen" style="z-index:220;">
  <div class="battle-result-crown" id="battleCrown">üëë</div>
  <div class="battle-result-title" id="battleResultTitle">P1 „ÅÆÂãù„Å°ÔºÅ</div>
  <div class="battle-result-players">
    <div class="battle-result-card p1" id="battleResultP1">
      <div class="battle-result-label">üîµ P1</div>
      <div class="battle-result-score" id="battleResultP1Score">0</div>
      <div class="battle-result-detail" id="battleResultP1Detail">Ê≠£Ëß£: 0 / Ê≠£Ëß£Áéá: 0%</div>
    </div>
    <div class="battle-result-card p2" id="battleResultP2">
      <div class="battle-result-label">üî¥ P2</div>
      <div class="battle-result-score" id="battleResultP2Score">0</div>
      <div class="battle-result-detail" id="battleResultP2Detail">Ê≠£Ëß£: 0 / Ê≠£Ëß£Áéá: 0%</div>
    </div>
  </div>
  <div style="display:flex;gap:12px;margin-top:10px;">
    <button class="btn" style="padding:12px 28px;font-size:1rem;background:linear-gradient(135deg,#2a6b3a,#1e5a2e);border-color:#3a8b4a;" onclick="startBattle(battleState.mode)">‚öîÔ∏è „ÇÇ„ÅÜ‰∏ÄÂõûÔºÅ</button>
    <button class="btn" style="padding:12px 28px;font-size:1rem;" onclick="battleGoHome()">üè† HOME</button>
  </div>
</div>
<div class="result-popup" id="resultPopup"></div>
<script>
// ‚îÄ‚îÄ‚îÄ TRAIL GP3 ÈÄ£Êê∫ ‚îÄ‚îÄ‚îÄ
const TRAIL_API = 'https://trail-game-pro-3-2.onrender.com';
const TRAIL_PLAYER = new URLSearchParams(location.search).get('player') || null;

async function sendResultToTrail(score, alt) {
  if (!TRAIL_PLAYER) return 0;
  try {
    await fetch(`${TRAIL_API}/api/external/game-result`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        player: TRAIL_PLAYER,
        game_id: 'bunsu-gunman',
        game_name: 'ÂàÜÊï∞„Ç¨„É≥„Éû„É≥',
        score: score,
        alt: alt
      })
    });
  } catch (e) {
    console.error('ALTÈÄÅ‰ø°Â§±Êïó:', e);
  }
  return alt;
}

function goHome() {
  window.location.href = TRAIL_PLAYER
    ? 'https://trail-game-pro-3-2.onrender.com'
    : location.href.split('?')[0];
}

function showStartScreen() {
  const ss = document.getElementById('startScreen');
  ss.classList.remove('hidden');
  ss.classList.remove('hidden-immediate');
  if (TRAIL_PLAYER) {
    document.getElementById('playerNameText').textContent = TRAIL_PLAYER;
    document.getElementById('playerInfo').classList.remove('hidden');
  }
  setAltBadgeVisible(true);
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ===================== STATE =====================
const state = {
  score:0, combo:0, maxCombo:0, totalCorrect:0, totalAttempts:0,
  currentAnswer:null, isAnimating:false,
  timeLeft:30.0, maxTime:30.0,
  timerRAF:null, lastTimestamp:0, gameRunning:false,
  questionStartTime:0,
  mode:'easy', gameMode:'normal',
  questionNum:0, totalQuestions:10,
  totalElapsed:0,
  lastCountdownNum:0,
  questionTimer:null, // per-question countdown for gunman mode
};

let selectedGameMode = 'normal';

// ===================== ALT SYSTEM =====================
let totalAlt = 0;
let clearedLevels = {}; // tracks first clears: { 'easy-normal': true, ... }
let highScore = 0;

function updateAltBadge() {
  const el = document.getElementById('altBadgeNum'); if (el) el.textContent = totalAlt;
}

function getAltReward(combo) {
  if (combo >= 4) return 2;
  return 1;
}

function showAltFloat(n) {
  const el = document.createElement('div'); el.className = 'alt-float';
  if (n < 0) { el.textContent = `${n} ALT`; el.style.color = 'var(--accent)'; el.style.textShadow = '0 0 10px rgba(192,57,43,0.6)'; }
  else { el.textContent = `+${n} ALT`; }
  el.style.left = (40 + Math.random() * 20) + '%';
  el.style.top = '42%';
  document.body.appendChild(el); setTimeout(() => el.remove(), 950);
}

function getStarRating(accuracy) {
  if (accuracy >= 100) return 3;
  if (accuracy >= 80) return 2;
  return 1;
}

function getStarBonus(stars) {
  if (stars === 3) return 10;
  if (stars === 2) return 5;
  return 2;
}

function getLevelKey() {
  return state.mode + '-' + state.gameMode;
}

function isFirstClear() {
  return !clearedLevels[getLevelKey()];
}

// ALT badge visibility: show on overlays, hide during gameplay
function setAltBadgeVisible(v) {
  document.getElementById('altBadge').classList.toggle('hidden', !v);
}


// ===================== FRACTION POOLS =====================
const easyPool = [
  {n:1,d:2},
  {n:1,d:3},{n:2,d:3},
  {n:1,d:4},{n:3,d:4},
  {n:1,d:5},{n:2,d:5},{n:3,d:5},{n:4,d:5},
  {n:1,d:6},{n:5,d:6},
];

// Normal: max denominator 10
const normalPool = [
  {n:1,d:3},{n:2,d:3},
  {n:1,d:4},{n:3,d:4},
  {n:1,d:5},{n:2,d:5},{n:3,d:5},{n:4,d:5},
  {n:1,d:6},{n:5,d:6},
  {n:1,d:7},{n:2,d:7},{n:3,d:7},{n:4,d:7},{n:5,d:7},{n:6,d:7},
  {n:1,d:8},{n:3,d:8},{n:5,d:8},{n:7,d:8},
  {n:1,d:9},{n:2,d:9},{n:4,d:9},{n:5,d:9},{n:7,d:9},{n:8,d:9},
  {n:1,d:10},{n:3,d:10},{n:7,d:10},{n:9,d:10},
];

const hardPool = [
  {n:1,d:3},{n:2,d:6},{n:3,d:9},
  {n:1,d:4},{n:2,d:8},{n:3,d:12},
  {n:1,d:2},{n:2,d:4},{n:3,d:6},{n:4,d:8},{n:5,d:10},
  {n:2,d:3},{n:4,d:6},{n:6,d:9},
  {n:3,d:4},{n:6,d:8},{n:9,d:12},
  {n:3,d:5},{n:6,d:10},
  {n:1,d:7},{n:2,d:7},{n:3,d:7},{n:4,d:7},{n:5,d:7},{n:6,d:7},
  {n:1,d:9},{n:2,d:9},{n:4,d:9},{n:5,d:9},{n:7,d:9},{n:8,d:9},
  {n:3,d:16},{n:5,d:16},{n:7,d:16},{n:9,d:16},{n:11,d:16},{n:13,d:16},
  {n:1,d:20},{n:3,d:20},{n:7,d:20},{n:9,d:20},{n:11,d:20},{n:13,d:20},{n:17,d:20},{n:19,d:20},
];

const PIE_COLORS = ['#c0392b','#d4a654','#e67e22','#27ae60','#f0c040','#8b5e3c','#e74c3c','#2ecc71','#d35400','#c8a060','#a0301f','#f39c12'];

// ===================== HELPERS =====================
function gcd(a,b){return b===0?a:gcd(b,a%b);}
function simplify(n,d){const g=gcd(Math.abs(n),Math.abs(d));return{n:n/g,d:d/g};}
function fractionsEqual(a,b){const sa=simplify(a.n,a.d),sb=simplify(b.n,b.d);return sa.n===sb.n&&sa.d===sb.d;}
function shuffle(a){const r=[...a];for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];}return r;}
function pickRandom(a){return a[Math.floor(Math.random()*a.length)];}
function getPool(){return state.mode==='easy'?easyPool:state.mode==='normal'?normalPool:hardPool;}
function getNumDummies(){return state.mode==='easy'?3:state.mode==='normal'?4:5;}

// Speed config per game mode
function getSpeed() {
  if (state.gameMode === 'gunman') {
    return { nextDelay: 450, pieEnter: '0.15s', cardStagger: 28, shardFly: '0.4s', shardClean: 500 };
  } else {
    return { nextDelay: 800, pieEnter: '0.3s', cardStagger: 50, shardFly: '0.7s', shardClean: 900 };
  }
}

// ===================== WESTERN EFFECTS =====================
function showBang() {
  const el = document.createElement('div'); el.className = 'bang-effect';
  const bangs = ['BANG!', 'BANG!!', 'POW!', 'BOOM!'];
  el.innerHTML = `<div class="bang-text">${pickRandom(bangs)}üí•</div>`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 750);
}

function showTumbleweed() {
  const el = document.createElement('div'); el.className = 'tumbleweed';
  el.textContent = 'üåø';
  el.style.bottom = (10 + Math.random() * 30) + '%';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}

function showCoinFloat(n) {} // deprecated

function getComboTitle(combo) {
  if (combo >= 10) return 'ü§† ‰ºùË™¨„ÅÆ„Ç¨„É≥„Éû„É≥ÔºÅ';
  if (combo >= 7) return '‚≠ê ‰øùÂÆâÂÆòÔºÅ';
  if (combo >= 5) return 'üî• ÁÑ°Ê≥ïËÄÖÔºÅ';
  if (combo >= 3) return 'üí® Êó©ÊíÉ„Å°ÔºÅ';
  return '';
}

function getQuestionTimeLimit() {
  return state.mode === 'easy' ? 2000 : state.mode === 'normal' ? 3000 : 4000;
}

function startQuestionTimer() {
  clearQuestionTimer();
  if (state.gameMode !== 'gunman') return;
  state.questionTimer = setTimeout(() => questionTimeout(), getQuestionTimeLimit());
}

function clearQuestionTimer() {
  if (state.questionTimer) { clearTimeout(state.questionTimer); state.questionTimer = null; }
}

function questionTimeout() {
  if (!state.gameRunning || state.isAnimating) return;
  state.isAnimating = true;
  state.totalAttempts++;
  state.combo = 0; updateCombo();
  // -4 second penalty
  subtractTime(4.0);
  showDrawEffect();
  showTumbleweed();
  const pieEl = document.getElementById('pieChart'); pieEl.classList.add('shake');
  setTimeout(() => {
    pieEl.classList.remove('shake');
    if (!state.gameRunning) { state.isAnimating = false; return; }
    generateQuestion(); state.isAnimating = false;
  }, 1200);
}

function showDrawEffect() {
  const dim = document.createElement('div'); dim.className = 'draw-overlay';
  document.body.appendChild(dim); setTimeout(() => dim.remove(), 1300);
  const txt = document.createElement('div'); txt.className = 'draw-text';
  txt.innerHTML = '<span>DRAW...<span class="draw-sub">üî´ Êäú„Åë„Å™„Åã„Å£„Åü‚Ä¶ ‚àí4Áßí</span></span>';
  document.body.appendChild(txt); setTimeout(() => txt.remove(), 1300);
}

function subtractTime(seconds) {
  if (state.gameMode !== 'gunman') return;
  state.timeLeft = Math.max(0, state.timeLeft - seconds);
  updateBarUI();
  const timerArea = document.querySelector('.timer-area');
  const rect = timerArea.getBoundingClientRect();
  const el = document.createElement('div'); el.className = 'time-penalty-float';
  el.textContent = `‚àí${seconds.toFixed(1)}Áßí`;
  el.style.left = (rect.left + rect.width * 0.5) + 'px'; el.style.top = (rect.bottom + 5) + 'px';
  document.body.appendChild(el); setTimeout(() => el.remove(), 1200);
  if (state.timeLeft <= 0) endGame();
}

// ===================== MODE SWITCH (start screen) =====================
function switchMode(mode) {
  if (mode === 'battle') {
    showBattleSetup();
    return;
  }
  selectedGameMode = mode;
  // Sync all mode tabs (start screen + game over screen)
  document.getElementById('modeTabNormal').classList.toggle('active', mode==='normal');
  document.getElementById('modeTabGunman').classList.toggle('active', mode==='gunman');
  document.getElementById('modeTabBattle').classList.remove('active');
  document.getElementById('modeTabNormal2').classList.toggle('active', mode==='normal');
  document.getElementById('modeTabGunman2').classList.toggle('active', mode==='gunman');
  document.getElementById('modeDesc').textContent = mode==='normal'
    ? '10Âïè„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ„Åò„Å£„Åè„ÇäÊ≠£Á¢∫„Å´Á≠î„Åà„Çà„ÅÜ'
    : '30ÁßíÔºÅÈÄü„ÅèÊ≠£Á¢∫„Å´„Éê„Ç∑„Éê„Ç∑ÊíÉ„Å°Êäú„ÅëÔºÅüí•';
}

// ===================== DRAW PIE =====================
function drawPieChart(canvas, fraction) {
  const ctx=canvas.getContext('2d');
  const w=canvas.width,h=canvas.height,cx=w/2,cy=h/2,r=w/2-10;
  ctx.clearRect(0,0,w,h);
  const {n,d}=fraction;
  const sSimp=simplify(n,d);
  const sliceAngle=(2*Math.PI)/d;
  const startOffset=-Math.PI/2;
  for(let i=0;i<d;i++){
    const start=startOffset+i*sliceAngle,end=start+sliceAngle;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,start,end);ctx.closePath();
    ctx.fillStyle=i<n?PIE_COLORS[i%PIE_COLORS.length]:'rgba(255,255,255,0.07)';
    ctx.fill();
  }
  ctx.strokeStyle='rgba(80,80,80,0.8)';ctx.lineWidth=2.5;
  for(let i=0;i<d;i++){
    const angle=startOffset+i*sliceAngle;
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(angle)*r,cy+Math.sin(angle)*r);ctx.stroke();
  }
  if(state.mode==='hard'&&d!==sSimp.d){
    const simpSlice=(2*Math.PI)/sSimp.d;
    ctx.setLineDash([6,4]);ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=1.5;
    for(let i=0;i<sSimp.d;i++){
      const angle=startOffset+i*simpSlice;
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.lineTo(cx+Math.cos(angle)*r,cy+Math.sin(angle)*r);ctx.stroke();
    }
    ctx.setLineDash([]);
  }
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle='rgba(80,80,80,0.8)';ctx.lineWidth=3;ctx.stroke();
  const grad=ctx.createRadialGradient(cx-r*0.3,cy-r*0.3,0,cx,cy,r);
  grad.addColorStop(0,'rgba(255,255,255,0.1)');grad.addColorStop(1,'rgba(255,255,255,0)');
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle=grad;ctx.fill();
}

// ===================== SHATTER =====================
function shatterPie(){
  const container=document.getElementById('shatterContainer');
  const canvas=document.getElementById('pieCanvas');
  const pieEl=document.getElementById('pieChart');
  const imgData=canvas.toDataURL();
  pieEl.style.opacity='0';pieEl.style.transform='scale(0.7)';
  const cw=210;
  for(let i=0;i<10;i++){
    const shard=document.createElement('div');shard.className='shard';
    const angle=(i/10)*Math.PI*2,dist=60+Math.random()*100;
    const tx=Math.cos(angle)*dist,ty=Math.sin(angle)*dist;
    const rot=(Math.random()-0.5)*720,size=22+Math.random()*35;
    const half=cw/2;
    const ox=half+Math.cos(angle)*30-size/2,oy=half+Math.sin(angle)*30-size/2;
    const pts=[];for(let j=0;j<4+Math.floor(Math.random()*3);j++)pts.push(`${Math.random()*100}% ${Math.random()*100}%`);
    shard.style.cssText=`left:${ox}px;top:${oy}px;width:${size}px;height:${size}px;background-image:url(${imgData});background-size:${cw}px ${cw}px;background-position:-${ox}px -${oy}px;clip-path:polygon(${pts.join(',')});--tx:${tx}px;--ty:${ty}px;--rot:${rot}deg;animation:shard-fly ${getSpeed().shardFly} ease-out forwards;`;
    container.appendChild(shard);
  }
  spawnSparkles();
  setTimeout(()=>{container.innerHTML='';},getSpeed().shardClean);
}
function spawnSparkles(){
  const burst=document.getElementById('sparkleBurst');
  const colors=['#f0c040','#c0392b','#d4a654','#fff','#e8a020'];
  for(let i=0;i<16;i++){
    const s=document.createElement('div');s.className='sparkle';
    const angle=Math.random()*Math.PI*2,dist=40+Math.random()*80;
    s.style.cssText=`--sx:${Math.cos(angle)*dist}px;--sy:${Math.sin(angle)*dist}px;background:${pickRandom(colors)};width:${3+Math.random()*5}px;height:${3+Math.random()*5}px;animation-duration:${0.4+Math.random()*0.4}s;`;
    burst.appendChild(s);
  }
  setTimeout(()=>{burst.innerHTML='';},1000);
}

// ===================== TIMER (gunman mode) =====================
function startTimer(){
  state.lastTimestamp=performance.now();
  function tick(now){
    if(!state.gameRunning)return;
    const delta=(now-state.lastTimestamp)/1000;
    state.lastTimestamp=now;
    state.timeLeft=Math.max(0,state.timeLeft-delta);
    updateBarUI();
    if(state.timeLeft<=5&&state.timeLeft>0){
      const cn=Math.ceil(state.timeLeft);
      if(cn!==state.lastCountdownNum&&cn>=1&&cn<=5){state.lastCountdownNum=cn;showCountdown(cn);}
    }
    if(state.timeLeft<=0){endGame();return;}
    state.timerRAF=requestAnimationFrame(tick);
  }
  state.timerRAF=requestAnimationFrame(tick);
}

// ===================== BAR UI =====================
function updateBarUI(){
  const fill=document.getElementById('timerBarFill');
  const text=document.getElementById('timerText');
  if(state.gameMode==='gunman'){
    const pct=(state.timeLeft/state.maxTime)*100;
    fill.style.width=pct+'%';
    fill.classList.remove('progress');
    const danger=state.timeLeft<=8;
    fill.classList.toggle('danger',danger);
    text.classList.toggle('danger',danger);
    text.textContent=state.timeLeft.toFixed(1);
  } else {
    // Normal mode: show question progress
    const pct=(state.questionNum/state.totalQuestions)*100;
    fill.style.width=pct+'%';
    fill.classList.remove('danger');
    fill.classList.add('progress');
    text.classList.remove('danger');
    text.textContent=`${state.questionNum}/${state.totalQuestions}`;
  }
}

function addTime(seconds){
  if(state.gameMode!=='gunman')return;
  state.timeLeft=Math.min(state.timeLeft+seconds,state.maxTime);
  updateBarUI();
  const timerArea=document.querySelector('.timer-area');
  const rect=timerArea.getBoundingClientRect();
  const el=document.createElement('div');el.className='time-bonus-float';
  el.textContent=`+${seconds.toFixed(1)}Áßí`;
  el.style.left=(rect.left+rect.width*0.5)+'px';el.style.top=(rect.bottom+5)+'px';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1000);
}

// ===================== COUNTDOWN =====================
function showCountdown(num){
  const el=document.createElement('div');el.className='countdown-num';el.textContent=num;
  document.body.appendChild(el);setTimeout(()=>el.remove(),950);
  const flash=document.createElement('div');flash.className='screen-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),350);
  const tt=document.getElementById('timerText');tt.classList.remove('countdown-pulse');
  void tt.offsetWidth;tt.classList.add('countdown-pulse');
  setTimeout(()=>tt.classList.remove('countdown-pulse'),450);
}

// ===================== UI =====================
function updateScore(){document.getElementById('scoreText').textContent=state.score;}
function updateCombo(){
  const el=document.getElementById('comboDisplay');
  if(state.combo>=2){el.textContent=`üî• x${state.combo}`;el.classList.remove('active');void el.offsetWidth;el.classList.add('active');}
  else{el.classList.remove('active');}
}
function updateCorrectCount(){document.getElementById('correctCount').textContent=`Ê≠£Ëß£: ${state.totalCorrect}`;}
function showPopup(t,c){const el=document.getElementById('resultPopup');el.textContent=t;el.className='result-popup '+c;void el.offsetWidth;el.className='result-popup '+c;}

// ===================== GENERATE QUESTION =====================
function generateQuestion(){
  const pool=getPool();const numDummies=getNumDummies();
  const answer=pickRandom(pool);state.currentAnswer=answer;state.questionStartTime=Date.now();
  const dummies=[];let attempts=0;
  while(dummies.length<numDummies&&attempts<200){attempts++;const c=pickRandom(pool);if(!fractionsEqual(c,answer)&&!dummies.some(d=>fractionsEqual(d,c)))dummies.push(c);}
  const allPools=[...easyPool,...normalPool,...hardPool];
  while(dummies.length<numDummies){const c=pickRandom(allPools);if(!fractionsEqual(c,answer)&&!dummies.some(d=>fractionsEqual(d,c)))dummies.push(c);}
  const options=shuffle([answer,...dummies]);
  const canvas=document.getElementById('pieCanvas');
  const pieEl=document.getElementById('pieChart');
  pieEl.style.opacity='1';pieEl.style.transform='scale(1)';
  pieEl.classList.remove('entering');void pieEl.offsetWidth;
  pieEl.style.animationDuration=getSpeed().pieEnter;
  pieEl.classList.add('entering');
  drawPieChart(canvas,answer);
  const cardsArea=document.getElementById('cardsArea');cardsArea.innerHTML='';
  options.forEach((frac,idx)=>{
    const card=document.createElement('div');card.className='fraction-card';
    card.innerHTML=`<span class="numerator">${frac.n}</span><div class="fraction-bar"></div><span class="denominator">${frac.d}</span>`;
    card.addEventListener('click',(e)=>{e.preventDefault();confirmAnswer(frac,card);});
    card.addEventListener('touchend',(e)=>{e.preventDefault();confirmAnswer(frac,card);});
    cardsArea.appendChild(card);
    card.style.opacity='0';card.style.transform='translateY(16px)';
    setTimeout(()=>{card.style.transition='opacity 0.2s ease,transform 0.2s ease,box-shadow 0.2s,border-color 0.2s,background 0.2s';card.style.opacity='1';card.style.transform='translateY(0)';},30+idx*getSpeed().cardStagger);
  });
  const texts=state.mode==='hard'
    ?['Á¥ÑÂàÜ„Å´Ê≥®ÊÑè„Åó„Å¶ÊíÉ„Å¶ÔºÅü§†','Âêå„ÅòÂ§ß„Åç„Åï„ÅÆÂàÜÊï∞„ÇíË¶ã„Å§„Åë„ÇçÔºÅ','Ê≠£„Åó„ÅÑÂàÜÊï∞„ÇíÊíÉ„Å°Êäú„ÅëÔºÅ']
    :['„Åì„ÅÆÁöÑ„ÅÆÂàÜÊï∞„ÅØÔºüüéØ','Ëâ≤„ÅÆ„Å§„ÅÑ„ÅüÈÉ®ÂàÜ„ÇíÊíÉ„Å¶ÔºÅ','ÊíÉ„Å°Êäú„ÅëÔºÅüî´'];
  document.getElementById('questionText').textContent=pickRandom(texts);
  startQuestionTimer();
}

// ===================== CONFIRM ANSWER =====================
function confirmAnswer(frac,card){
  if(state.isAnimating||!state.gameRunning)return;
  clearQuestionTimer();
  state.isAnimating=true;state.totalAttempts++;
  if(fractionsEqual(frac,state.currentAnswer)){
    state.combo++;if(state.combo>state.maxCombo)state.maxCombo=state.combo;
    state.totalCorrect++;
    const points=100*Math.max(1,state.combo);state.score+=points;
    updateScore();updateCombo();updateCorrectCount();shatterPie();showBang();
    const elapsed=(Date.now()-state.questionStartTime)/1000;
    state.totalElapsed+=elapsed;
    // Gunman mode time bonus (hell settings, hard has special bonus)
    if(state.gameMode==='gunman'){
      let tb=0;
      if(state.mode==='hard'){
        if(elapsed<1)tb=1.0;if(state.combo>=3)tb+=0.5;
      } else {
        if(elapsed<1)tb=0.3;if(state.combo>=10)tb+=0.3;
      }
      if(tb>0)addTime(tb);
    }
    const comboTitle = getComboTitle(state.combo);
    const popupText = comboTitle ? `${comboTitle} x${state.combo} +${points}ÁÇπ`
      : state.combo>=2 ? `üí® Êó©ÊíÉ„Å°ÔºÅ +${points}ÁÇπ` : 'üí• ÂëΩ‰∏≠ÔºÅ';
    showPopup(popupText,'correct');
    setTimeout(()=>{
      if(!state.gameRunning)return;
      if(state.gameMode==='normal'){
        state.questionNum++;updateBarUI();
        if(state.questionNum>=state.totalQuestions){endGame();state.isAnimating=false;return;}
      }
      generateQuestion();state.isAnimating=false;
    },getSpeed().nextDelay);
  } else {
    state.combo=0;updateCombo();
    const pieEl=document.getElementById('pieChart');pieEl.classList.add('shake');
    card.classList.add('disabled');showPopup('üí® „Éè„Ç∫„É¨ÔºÅ','wrong');showTumbleweed();
    // Gray flash
    const gf=document.createElement('div');gf.className='gray-flash';document.body.appendChild(gf);setTimeout(()=>gf.remove(),450);
    if(state.gameMode==='gunman')subtractTime(2.0);
    setTimeout(()=>{pieEl.classList.remove('shake');state.isAnimating=false;},450);
  }
}

// ===================== GAME FLOW =====================
function startGame(mode){
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('rankingOverlay').classList.add('hidden');
  document.getElementById('nameEntryOverlay').classList.add('hidden');

  state.mode=mode;
  state.gameMode=selectedGameMode;
  Object.assign(state,{
    score:0,combo:0,maxCombo:0,totalCorrect:0,totalAttempts:0,
    isAnimating:false,timeLeft:30.0,gameRunning:true,
    lastCountdownNum:0,questionNum:0,totalElapsed:0,isQuit:false,
  });

  setAltBadgeVisible(false); // hide ALT during play
  const badge=document.getElementById('diffBadge');
  badge.className='diff-badge '+mode;
  badge.textContent=(mode==='easy'?'üå± „Åã„Çì„Åü„Çì':mode==='normal'?'‚ö° „Åµ„Å§„ÅÜ':'üî• „ÇÄ„Åö„Åã„Åó„ÅÑ');

  updateScore();updateCombo();updateCorrectCount();updateBarUI();
  if(state.timerRAF)cancelAnimationFrame(state.timerRAF);
  if(state.gameMode==='gunman')startTimer();
  generateQuestion();
}

function endGame(){
  state.gameRunning=false;
  clearQuestionTimer();
  if(state.timerRAF)cancelAnimationFrame(state.timerRAF);
  setTimeout(async ()=>{
    document.getElementById('finalScore').textContent=state.score;
    document.getElementById('finalCorrect').textContent=state.totalCorrect;
    document.getElementById('finalCombo').textContent=state.maxCombo;
    const acc=state.totalAttempts>0?Math.round((state.totalCorrect/state.totalAttempts)*100):0;
    document.getElementById('finalAccuracy').textContent=acc+'%';
    // Show total time in normal mode
    const timeRow=document.getElementById('finalTimeRow');
    if(state.gameMode==='normal'){
      timeRow.style.display='';
      document.getElementById('finalTime').textContent=state.totalElapsed.toFixed(1)+'Áßí';
    } else {
      timeRow.style.display='none';
    }
    const title=state.totalCorrect>=20?'ü§† ‰ºùË™¨„ÅÆ„Ç¨„É≥„Éû„É≥ÔºÅ':state.totalCorrect>=12?'üåü ÂáÑËÖï„Ç¨„É≥„Éû„É≥ÔºÅ':state.totalCorrect>=6?'üåµ „ÅÑ„ÅÑËÖï„Å†ÔºÅ':'üèúÔ∏è Êó•„ÅåÊöÆ„Çå„ÅüÔºÅ';
    document.getElementById('gameOverTitle').textContent=title;

    // ALT = clear reward only (not per-answer)
    const stars = getStarRating(acc);
    const starBonus = getStarBonus(stars);
    let firstClearBonus = 0;
    const isFirst = isFirstClear() && state.totalCorrect > 0;
    if (isFirst) { firstClearBonus = 3; clearedLevels[getLevelKey()] = true; }
    const totalEarned = starBonus + firstClearBonus;
    totalAlt += totalEarned;
    if (state.score > highScore) highScore = state.score;

    // Star display
    const starStr = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
    document.getElementById('altStars').textContent = starStr;
    document.getElementById('altEarned').textContent = totalEarned > 0 ? `ü™ô +${totalEarned} ALT` : '';
    document.getElementById('altScore').textContent = `„Çπ„Ç≥„Ç¢: ${state.score}ÁÇπ`;
    let bd = [];
    bd.push(`${starStr}: +${starBonus}`);
    if (firstClearBonus > 0) bd.push(`Âàù„ÇØ„É™„Ç¢: +${firstClearBonus}`);
    document.getElementById('altBreakdown').textContent = bd.join(' / ');
    const fcEl = document.getElementById('altFirstClear');
    fcEl.classList.toggle('hidden', !isFirst);
    document.getElementById('altTotal').textContent = `ÂêàË®à: ${totalAlt} ALT`;

    // TRAIL GP3: „ÇØ„É™„Ç¢ÊàêÂäüÊôÇ„ÅÆ„Åø„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°ÔºàÈÄî‰∏≠„É™„Çø„Ç§„Ç¢„ÅØÈô§Â§ñÔºâ
    if (!state.isQuit && state.score > 0) {
      const alt = await sendResultToTrail(state.score, totalEarned);
      if (TRAIL_PLAYER && alt > 0) {
        document.getElementById('altEarned').textContent = `ü™ô ${alt} ALT „ÇíÁç≤ÂæóÔºÅ`;
      }
    }

    setAltBadgeVisible(true);
    updateAltBadge();
    document.getElementById('gameOverScreen').classList.remove('hidden');
    // Mini ranking + register button (gunman only)
    const regBtn=document.getElementById('registerRankBtn');
    const detBtn=document.getElementById('rankDetailBtn');
    if(state.gameMode==='gunman'){
      renderMiniRanking(state.gameMode,state.mode,state.score);
      regBtn.style.display=state.score>0?'':'none';
      detBtn.style.display='';
    } else {
      document.getElementById('miniRanking').innerHTML='';
      document.getElementById('rankGapText').textContent='';
      regBtn.style.display='none';
      detBtn.style.display='none';
    }
  },500);
}

function quitGame(){state.isQuit=true;endGame();}

// ===================== RANKING (weekly + alltime, mode x difficulty) =====================
const MAX_RANKING=7;
const RANK_MODES=['normal','gunman'];
const RANK_DIFFS=['easy','normal','hard'];

// Two stores: weekly and alltime. Each keyed by 'normal-easy' etc.
let weeklyRankings={};let alltimeRankings={};
let prevWeeklyRankings={}; // snapshot for arrow comparison
RANK_MODES.forEach(m=>RANK_DIFFS.forEach(d=>{const k=m+'-'+d;weeklyRankings[k]=[];alltimeRankings[k]=[];prevWeeklyRankings[k]=[];}));

let currentRankPeriod='weekly';let currentRankMode='normal';let currentRankDiff='easy';
let lastNewEntryId=null;let pendingEntry=null;let selectedGrade='';

function getRankKey(gm,diff){return gm+'-'+diff;}
function currentRankKey(){return getRankKey(currentRankMode,currentRankDiff);}
function getRankStore(period){return period==='weekly'?weeklyRankings:alltimeRankings;}

// Weekly reset: Monday 4:00 AM JST
function getWeekStart(){
  const now=new Date();
  const jst=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Tokyo'}));
  const day=jst.getDay();const hrs=jst.getHours();
  // Go back to most recent Monday 4:00
  let daysBack=(day===0?6:day-1);
  if(day===1&&hrs<4)daysBack=7;
  const mon=new Date(jst);mon.setDate(mon.getDate()-daysBack);
  mon.setHours(4,0,0,0);return mon.getTime();
}

function getNextReset(){
  const ws=getWeekStart();return new Date(ws+7*24*60*60*1000);
}

function getResetCountdown(){
  const next=getNextReset();const now=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Tokyo'}));
  const diff=next-now;if(diff<=0)return '„Åæ„ÇÇ„Å™„Åè„É™„Çª„ÉÉ„Éà';
  const d=Math.floor(diff/(24*60*60*1000));const h=Math.floor((diff%(24*60*60*1000))/(60*60*1000));
  if(d>0)return `„É™„Çª„ÉÉ„Éà„Åæ„Åß ${d}Êó•${h}ÊôÇÈñì`;
  const m=Math.floor((diff%(60*60*1000))/(60*1000));
  return `„É™„Çª„ÉÉ„Éà„Åæ„Åß ${h}ÊôÇÈñì${m}ÂàÜ`;
}

async function loadRankings(){
  try{
    const r=await window.storage.get('fg-rankings-v3');
    if(r&&r.value){
      const d=JSON.parse(r.value);
      if(d.weekly)Object.keys(d.weekly).forEach(k=>{if(weeklyRankings.hasOwnProperty(k))weeklyRankings[k]=d.weekly[k];});
      if(d.alltime)Object.keys(d.alltime).forEach(k=>{if(alltimeRankings.hasOwnProperty(k))alltimeRankings[k]=d.alltime[k];});
      if(d.weekStart){
        const currentWeekStart=getWeekStart();
        if(d.weekStart<currentWeekStart){
          // Week has rolled over - save prev for arrows, then reset
          RANK_MODES.forEach(m=>RANK_DIFFS.forEach(dd=>{const k=m+'-'+dd;prevWeeklyRankings[k]=[...weeklyRankings[k]];weeklyRankings[k]=[];}));
          saveRankings();
        }
      }
    }
  }catch(e){}
}
async function saveRankings(){
  try{await window.storage.set('fg-rankings-v3',JSON.stringify({weekly:weeklyRankings,alltime:alltimeRankings,weekStart:getWeekStart()}));}catch(e){}
}

function sortEntries(list,gm){
  list.sort((a,b)=>{
    if(b.score!==a.score)return b.score-a.score;
    if(gm==='normal')return(a.time||9999)-(b.time||9999);
    return(b.correct||0)-(a.correct||0);
  });
  return list.slice(0,MAX_RANKING);
}

function qualifiesForRanking(gm,diff,score){
  if(score<=0)return false;
  // Check both weekly and alltime
  const wk=weeklyRankings[getRankKey(gm,diff)]||[];
  const at=alltimeRankings[getRankKey(gm,diff)]||[];
  const wOk=wk.length<MAX_RANKING||score>wk[wk.length-1].score;
  const aOk=at.length<MAX_RANKING||score>at[at.length-1].score;
  return wOk||aOk;
}

function getRankPosition(store,gm,diff,score){
  const list=store[getRankKey(gm,diff)]||[];
  for(let i=0;i<list.length;i++){if(score>list[i].score)return i+1;}
  return list.length+1;
}

function insertToRanking(gm,diff,name,grade,score,correct,maxCombo,extraInfo){
  const key=getRankKey(gm,diff);
  const id=Date.now().toString();
  const dateStr=new Date().toLocaleDateString('ja-JP',{month:'numeric',day:'numeric'});
  const entry={id,name,grade,score,correct,maxCombo,date:dateStr,...extraInfo};
  // Insert into both
  weeklyRankings[key].push({...entry});
  weeklyRankings[key]=sortEntries(weeklyRankings[key],gm);
  alltimeRankings[key].push({...entry});
  alltimeRankings[key]=sortEntries(alltimeRankings[key],gm);
  lastNewEntryId=id;
  saveRankings();
}

// Arrow: compare current position vs previous week
function getArrow(entry,store,key){
  const prev=prevWeeklyRankings[key]||[];
  if(!prev.length)return '';
  const curList=store[key]||[];
  const curIdx=curList.findIndex(e=>e.id===entry.id);
  // Find same name in prev
  const prevIdx=prev.findIndex(e=>e.name===entry.name);
  if(prevIdx===-1)return '<span class="ranking-arrow up">üÜï</span>';
  if(curIdx<prevIdx)return '<span class="ranking-arrow up">‚Üë</span>';
  if(curIdx>prevIdx)return '<span class="ranking-arrow down">‚Üì</span>';
  return '<span class="ranking-arrow same">‚Üí</span>';
}

function showNameEntry(gm,diff,score,correct,maxCombo,extraInfo){
  const wRank=getRankPosition(weeklyRankings,gm,diff,score);
  const aRank=getRankPosition(alltimeRankings,gm,diff,score);
  const bestRank=Math.min(wRank,aRank);
  const medals=['üëë','ü•à','ü•â'];const rl=bestRank<=3?medals[bestRank-1]+' '+bestRank+'‰Ωç':bestRank+'‰Ωç';
  document.getElementById('nameEntryRankText').textContent=rl+' „Å´„É©„É≥„ÇØ„Ç§„É≥ÔºÅ';
  const modeLabel=gm==='gunman'?'üî´„Ç¨„É≥„Éû„É≥':'üìùÈÄöÂ∏∏';
  const diffLabel=diff==='easy'?'„Åã„Çì„Åü„Çì':diff==='normal'?'„Åµ„Å§„ÅÜ':'„ÇÄ„Åö„Åã„Åó„ÅÑ';
  document.getElementById('nameEntryScoreText').textContent=`${modeLabel} ${diffLabel} / „Çπ„Ç≥„Ç¢: ${score}`;
  document.getElementById('nameEntryInput').value='';
  document.querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('selected'));selectedGrade='';
  pendingEntry={gm,diff,score,correct,maxCombo,extraInfo};
  document.getElementById('nameEntryOverlay').classList.remove('hidden');
  setTimeout(()=>document.getElementById('nameEntryInput').focus(),100);
}
function selectGrade(btn){document.querySelectorAll('.grade-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');selectedGrade=btn.dataset.grade;}
function confirmNameEntry(){
  if(!pendingEntry)return;
  const name=(document.getElementById('nameEntryInput').value||'').trim()||'ÂêçÁÑ°„Åó';
  const{gm,diff,score,correct,maxCombo,extraInfo}=pendingEntry;
  insertToRanking(gm,diff,name,selectedGrade,score,correct,maxCombo,extraInfo);
  pendingEntry=null;document.getElementById('nameEntryOverlay').classList.add('hidden');
  currentRankPeriod='weekly';currentRankMode='gunman';currentRankDiff=diff;showRanking();
}
function skipNameEntry(){pendingEntry=null;lastNewEntryId=null;document.getElementById('nameEntryOverlay').classList.add('hidden');}

function startNameEntry(){
  showNameEntry(state.gameMode,state.mode,state.score,state.totalCorrect,state.maxCombo,{});
}

// Mini ranking (TOP3) for result screen
function renderMiniRanking(gm,diff,myScore){
  const el=document.getElementById('miniRanking');
  const wList=(weeklyRankings[getRankKey(gm,diff)]||[]).slice(0,3);
  if(!wList.length){el.innerHTML='';return;}
  let html='<div class="mini-ranking-title">üî• ‰ªäÈÄ±„ÅÆTOP3</div>';
  wList.forEach((e,i)=>{
    const medals=['üëë','ü•à','ü•â'];
    const rc=i===0?'r1':i===1?'r2':i===2?'r3':'';
    const isNew=e.id===lastNewEntryId;
    html+=`<div class="mini-entry ${isNew?'highlight':''}"><div class="mini-rank ${rc}">${medals[i]}</div><div class="mini-name">${e.name}</div><div class="mini-score">${e.score}</div></div>`;
  });
  el.innerHTML=html;
  // Gap text
  const gapEl=document.getElementById('rankGapText');
  const wk=weeklyRankings[getRankKey(gm,diff)]||[];
  if(wk.length>=MAX_RANKING&&myScore<=wk[wk.length-1].score){
    const gap=wk[wk.length-1].score-myScore+1;
    gapEl.textContent=`„ÅÇ„Å® ${gap}ÁÇπ „ÅßÈÄ±Èñì„É©„É≥„ÇØ„Ç§„É≥ÔºÅ`;
  } else if(wk.length>0&&!wk.find(e=>e.id===lastNewEntryId)){
    const lastScore=wk[wk.length-1]?.score||0;
    if(myScore<=lastScore){
      const gap=lastScore-myScore+1;
      gapEl.textContent=`„ÅÇ„Å® ${gap}ÁÇπ „ÅßÈÄ±Èñì„É©„É≥„ÇØ„Ç§„É≥ÔºÅ`;
    } else {gapEl.textContent='';}
  } else {gapEl.textContent='';}
}

// Full ranking list render
function renderRankingList(){
  const store=getRankStore(currentRankPeriod);
  const key=currentRankKey();
  const list=document.getElementById('rankingList');
  const entries=store[key]||[];
  // Reset info
  const resetEl=document.getElementById('rankResetInfo');
  if(currentRankPeriod==='weekly'){resetEl.textContent=getResetCountdown();}
  else{resetEl.textContent='ÂÖ®ÊúüÈñì„ÅÆË®òÈå≤';}

  if(!entries.length){list.innerHTML='<div class="ranking-empty">„Åæ„Å†Ë®òÈå≤„Åå„Å™„ÅÑ„ÇàÔºÅ</div>';document.getElementById('rankingBest').textContent='';return;}
  const isNormal=currentRankMode==='normal';
  const isWeekly=currentRankPeriod==='weekly';
  list.innerHTML=entries.map((e,i)=>{
    const rc=i===0?'r1':i===1?'r2':i===2?'r3':'';
    const medals=['üëë','ü•à','ü•â'];const rl=i<3?medals[i]:(i+1);
    const isNew=e.id===lastNewEntryId;
    const gt=e.grade?`<span class="ranking-grade">${e.grade}</span>`:'';
    const dateStr=e.date?`<div class="ranking-date">${e.date}</div>`:'';
    const detail=isNormal
      ?`${e.correct}Âïè / ${e.time?e.time.toFixed(1)+'Áßí':'--'}`
      :`${e.correct}Âïè / „Ç≥„É≥„Éú${e.maxCombo}`;
    const arrow=isWeekly?getArrow(e,store,key):'';
    return `<div class="ranking-entry ${isNew?'highlight':''}"><div class="ranking-rank ${rc}">${rl}${arrow}</div><div class="ranking-name">${e.name} ${gt}${isNew?'<span class="new-record-badge"> NEW!</span>':''}</div><div style="text-align:right"><div class="ranking-score">${e.score}</div><div class="ranking-detail">${detail}</div>${dateStr}</div></div>`;
  }).join('');
  const best=entries[0];
  document.getElementById('rankingBest').textContent=best?`üéØ „Éô„Çπ„Éà: ${best.score}ÁÇπÔºà${best.name}Ôºâ`:'';
}

function switchRankPeriod(p){
  currentRankPeriod=p;
  document.getElementById('rankPeriodWeekly').classList.toggle('active',p==='weekly');
  document.getElementById('rankPeriodAlltime').classList.toggle('active',p==='alltime');
  renderRankingList();
}
function switchRankMode(m){
  currentRankMode=m;
  document.getElementById('rankModeNormal').classList.toggle('active',m==='normal');
  document.getElementById('rankModeGunman').classList.toggle('active',m==='gunman');
  renderRankingList();
}
function switchRankDiff(d){
  currentRankDiff=d;
  document.querySelectorAll('#rankingOverlay .ranking-tab').forEach(t=>t.classList.remove('active'));
  const tabs=document.querySelectorAll('#rankingOverlay .ranking-tab');
  const idx=d==='easy'?0:d==='normal'?1:2;
  tabs[idx].classList.add('active');
  renderRankingList();
}
function showRanking(focusGm,focusDiff){
  currentRankMode='gunman'; // gunman only
  if(focusDiff)currentRankDiff=focusDiff;
  document.getElementById('rankPeriodWeekly').classList.toggle('active',currentRankPeriod==='weekly');
  document.getElementById('rankPeriodAlltime').classList.toggle('active',currentRankPeriod==='alltime');
  document.querySelectorAll('#rankingOverlay .ranking-tab').forEach(t=>t.classList.remove('active'));
  const tabs=document.querySelectorAll('#rankingOverlay .ranking-tab');
  const idx=currentRankDiff==='easy'?0:currentRankDiff==='normal'?1:2;
  tabs[idx].classList.add('active');
  renderRankingList();
  document.getElementById('rankingOverlay').classList.remove('hidden');
}
function hideRanking(){document.getElementById('rankingOverlay').classList.add('hidden');lastNewEntryId=null;}

loadRankings();
updateAltBadge();

// ===================== TRAIL GP3 INIT =====================
showStartScreen();

// ===================== BATTLE MODE =====================
const battleState = {
  p1: { score:0, combo:0, maxCombo:0, correct:0, attempts:0 },
  p2: { score:0, combo:0, maxCombo:0, correct:0, attempts:0 },
  currentAnswer: null,
  round: 0,
  totalRounds: 10,
  isAnimating: false,
  mode: 'easy',
  answered: null,
  active: false,
};

function showBattleSetup() {
  // Mark battle tab as active
  document.getElementById('modeTabNormal').classList.remove('active');
  document.getElementById('modeTabGunman').classList.remove('active');
  document.getElementById('modeTabBattle').classList.add('active');
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('battleSetupScreen').classList.remove('hidden');
}

function hideBattleSetup() {
  document.getElementById('battleSetupScreen').classList.add('hidden');
  document.getElementById('startScreen').classList.remove('hidden');
  // Reset battle tab to inactive, restore previous selected mode tab
  document.getElementById('modeTabBattle').classList.remove('active');
  document.getElementById('modeTabNormal').classList.toggle('active', selectedGameMode==='normal');
  document.getElementById('modeTabGunman').classList.toggle('active', selectedGameMode==='gunman');
}

function getBattlePool() {
  return battleState.mode==='easy'?easyPool:battleState.mode==='normal'?normalPool:hardPool;
}
function getBattleNumDummies() {
  return 5; // Always 6 choices (1 answer + 5 dummies) in battle mode
}

function startBattle(diff) {
  battleState.mode = diff;
  battleState.round = 0;
  battleState.isAnimating = false;
  battleState.answered = null;
  battleState.active = true;
  battleState.p1 = { score:0, combo:0, maxCombo:0, correct:0, attempts:0 };
  battleState.p2 = { score:0, combo:0, maxCombo:0, correct:0, attempts:0 };

  document.getElementById('battleSetupScreen').classList.add('hidden');
  document.getElementById('battleResultScreen').classList.add('hidden');
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('battleContainer').classList.remove('hidden');
  setAltBadgeVisible(false);

  updateBattleScores();
  battleNextRound();
}

function updateBattleScores() {
  document.getElementById('battleP1Score').textContent = battleState.p1.score;
  document.getElementById('battleP2Score').textContent = battleState.p2.score;
  const c1 = document.getElementById('battleP1Combo');
  if (battleState.p1.combo >= 2) { c1.textContent = 'üî• x' + battleState.p1.combo; c1.classList.add('active'); }
  else { c1.classList.remove('active'); }
  const c2 = document.getElementById('battleP2Combo');
  if (battleState.p2.combo >= 2) { c2.textContent = 'üî• x' + battleState.p2.combo; c2.classList.add('active'); }
  else { c2.classList.remove('active'); }
}

function battleNextRound() {
  battleState.round++;
  if (battleState.round > battleState.totalRounds) { endBattle(); return; }
  battleState.answered = null;
  battleState.isAnimating = false;
  document.getElementById('battleRound').textContent = `Round ${battleState.round} / ${battleState.totalRounds}`;
  document.getElementById('battleVsText').textContent = 'VS';
  generateBattleQuestion();
}

function generateBattleQuestion() {
  const pool = getBattlePool();
  const numDummies = getBattleNumDummies();
  const answer = pickRandom(pool);
  battleState.currentAnswer = answer;

  const dummies = [];
  let attempts = 0;
  while (dummies.length < numDummies && attempts < 200) {
    attempts++;
    const c = pickRandom(pool);
    if (!fractionsEqual(c, answer) && !dummies.some(d => fractionsEqual(d, c))) dummies.push(c);
  }
  const allPools = [...easyPool, ...normalPool, ...hardPool];
  while (dummies.length < numDummies) {
    const c = pickRandom(allPools);
    if (!fractionsEqual(c, answer) && !dummies.some(d => fractionsEqual(d, c))) dummies.push(c);
  }
  const options = shuffle([answer, ...dummies]);

  // Draw pie charts (P1 normal + P2 rotated)
  const origMode = state.mode;
  state.mode = battleState.mode;
  [['battlePieCanvas','battlePieChart'],['battlePieCanvasP2','battlePieChartP2']].forEach(([canvasId,pieId])=>{
    const canvas = document.getElementById(canvasId);
    const pieEl = document.getElementById(pieId);
    pieEl.style.opacity = '1'; pieEl.style.transform = 'scale(1)';
    pieEl.classList.remove('entering'); void pieEl.offsetWidth;
    pieEl.style.animationDuration = '0.2s';
    pieEl.classList.add('entering');
    drawPieChart(canvas, answer);
  });
  state.mode = origMode;

  // Render cards for both players (same options, different order for fairness)
  const p1Options = shuffle([...options]);
  const p2Options = shuffle([...options]);
  renderBattleCards('p1Cards', p1Options, 'p1');
  renderBattleCards('p2Cards', p2Options, 'p2');
}

function renderBattleCards(containerId, options, player) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  options.forEach((frac, idx) => {
    const card = document.createElement('div');
    card.className = 'fraction-card';
    card.innerHTML = `<span class="numerator">${frac.n}</span><div class="fraction-bar"></div><span class="denominator">${frac.d}</span>`;
    const handler = (e) => { e.preventDefault(); e.stopPropagation(); battleAnswer(player, frac, card); };
    card.addEventListener('click', handler);
    card.addEventListener('touchend', handler);
    container.appendChild(card);
    card.style.opacity = '0'; card.style.transform = 'translateY(10px)';
    setTimeout(() => {
      card.style.transition = 'opacity 0.15s ease,transform 0.15s ease,box-shadow 0.2s,border-color 0.2s,background 0.2s';
      card.style.opacity = '1'; card.style.transform = 'translateY(0)';
    }, 20 + idx * 25);
  });
}

function battleAnswer(player, frac, card) {
  if (battleState.isAnimating || !battleState.active) return;
  if (battleState.answered) return; // Only first answer counts per round

  const ps = battleState[player];
  ps.attempts++;
  const isCorrect = fractionsEqual(frac, battleState.currentAnswer);

  if (isCorrect) {
    battleState.answered = player;
    battleState.isAnimating = true;
    ps.combo++;
    if (ps.combo > ps.maxCombo) ps.maxCombo = ps.combo;
    ps.correct++;
    const points = 100 * Math.max(1, battleState.round);
    ps.score += points;

    // Reset other player's combo
    const other = player === 'p1' ? 'p2' : 'p1';
    battleState[other].combo = 0;

    updateBattleScores();
    battleShatterPie();

    // Show point float
    const floatEl = document.createElement('div');
    floatEl.className = 'battle-point-float ' + player;
    floatEl.textContent = `+${points}`;
    document.getElementById('battleContainer').appendChild(floatEl);
    setTimeout(() => floatEl.remove(), 850);

    // Flash effect
    const flashEl = document.createElement('div');
    flashEl.className = 'battle-flash correct ' + player;
    document.getElementById('battleContainer').appendChild(flashEl);
    setTimeout(() => flashEl.remove(), 450);

    // Disable all cards
    document.querySelectorAll('#p1Cards .fraction-card, #p2Cards .fraction-card').forEach(c => c.classList.add('disabled'));

    // Show who answered
    document.getElementById('battleVsText').textContent = player === 'p1' ? 'üîµ P1 üí•' : 'üî¥ P2 üí•';

    setTimeout(() => {
      if (!battleState.active) return;
      battleNextRound();
    }, 800);
  } else {
    // Wrong answer - disable only this card, penalize player
    card.classList.add('disabled');
    ps.combo = 0;
    updateBattleScores();

    // Flash wrong
    const flashEl = document.createElement('div');
    flashEl.className = 'battle-flash wrong ' + player;
    document.getElementById('battleContainer').appendChild(flashEl);
    setTimeout(() => flashEl.remove(), 450);

    // Brief lock for this player's cards
    const containerId = player + 'Cards';
    const cards = document.querySelectorAll('#' + containerId + ' .fraction-card:not(.disabled)');
    cards.forEach(c => { c.style.pointerEvents = 'none'; });
    setTimeout(() => {
      cards.forEach(c => { c.style.pointerEvents = ''; });
    }, 500);

    // If both players have exhausted all wrong options (no correct card visible), move on
    const p1Wrong = document.querySelectorAll('#p1Cards .fraction-card.disabled').length;
    const p2Wrong = document.querySelectorAll('#p2Cards .fraction-card.disabled').length;
    const totalCards = document.querySelectorAll('#p1Cards .fraction-card').length;
    if (p1Wrong >= totalCards - 1 && p2Wrong >= totalCards - 1) {
      // Both locked out on all wrong cards, just advance
      battleState.isAnimating = true;
      setTimeout(() => { if (battleState.active) battleNextRound(); }, 600);
    }
  }
}

function battleShatterPie() {
  [['battleShatterContainer','battlePieCanvas','battlePieChart'],
   ['battleShatterContainerP2','battlePieCanvasP2','battlePieChartP2']].forEach(([contId,canvId,pieId])=>{
    const container = document.getElementById(contId);
    const canvas = document.getElementById(canvId);
    const pieEl = document.getElementById(pieId);
    const imgData = canvas.toDataURL();
    pieEl.style.opacity = '0'; pieEl.style.transform = 'scale(0.7)';
    const cw = 120;
    for (let i = 0; i < 8; i++) {
      const shard = document.createElement('div'); shard.className = 'shard';
      const angle = (i / 8) * Math.PI * 2, dist = 40 + Math.random() * 60;
      const tx = Math.cos(angle) * dist, ty = Math.sin(angle) * dist;
      const rot = (Math.random() - 0.5) * 720, size = 16 + Math.random() * 25;
      const half = cw / 2;
      const ox = half + Math.cos(angle) * 20 - size / 2, oy = half + Math.sin(angle) * 20 - size / 2;
      const pts = []; for (let j = 0; j < 4 + Math.floor(Math.random() * 3); j++) pts.push(`${Math.random()*100}% ${Math.random()*100}%`);
      shard.style.cssText = `left:${ox}px;top:${oy}px;width:${size}px;height:${size}px;background-image:url(${imgData});background-size:${cw}px ${cw}px;background-position:-${ox}px -${oy}px;clip-path:polygon(${pts.join(',')});--tx:${tx}px;--ty:${ty}px;--rot:${rot}deg;animation:shard-fly 0.4s ease-out forwards;`;
      container.appendChild(shard);
    }
    setTimeout(() => { container.innerHTML = ''; }, 500);
  });
}

function endBattle() {
  battleState.active = false;
  document.getElementById('battleContainer').classList.add('hidden');

  const p1 = battleState.p1, p2 = battleState.p2;
  const titleEl = document.getElementById('battleResultTitle');
  const crownEl = document.getElementById('battleCrown');

  if (p1.score > p2.score) {
    titleEl.textContent = 'üîµ P1 „ÅÆÂãù„Å°ÔºÅ';
    titleEl.className = 'battle-result-title p1-win';
    crownEl.textContent = 'üëë';
    document.getElementById('battleResultP1').classList.add('winner');
    document.getElementById('battleResultP2').classList.remove('winner');
  } else if (p2.score > p1.score) {
    titleEl.textContent = 'üî¥ P2 „ÅÆÂãù„Å°ÔºÅ';
    titleEl.className = 'battle-result-title p2-win';
    crownEl.textContent = 'üëë';
    document.getElementById('battleResultP2').classList.add('winner');
    document.getElementById('battleResultP1').classList.remove('winner');
  } else {
    titleEl.textContent = 'Âºï„ÅçÂàÜ„ÅëÔºÅ';
    titleEl.className = 'battle-result-title draw-result';
    crownEl.textContent = 'ü§ù';
    document.getElementById('battleResultP1').classList.remove('winner');
    document.getElementById('battleResultP2').classList.remove('winner');
  }

  document.getElementById('battleResultP1Score').textContent = p1.score;
  const p1Acc = p1.attempts > 0 ? Math.round((p1.correct / p1.attempts) * 100) : 0;
  document.getElementById('battleResultP1Detail').textContent = `Ê≠£Ëß£: ${p1.correct} / Ê≠£Ëß£Áéá: ${p1Acc}%`;

  document.getElementById('battleResultP2Score').textContent = p2.score;
  const p2Acc = p2.attempts > 0 ? Math.round((p2.correct / p2.attempts) * 100) : 0;
  document.getElementById('battleResultP2Detail').textContent = `Ê≠£Ëß£: ${p2.correct} / Ê≠£Ëß£Áéá: ${p2Acc}%`;

  document.getElementById('battleResultScreen').classList.remove('hidden');
  setAltBadgeVisible(true);
  // TRAIL GP3: ÂØæÊà¶„É¢„Éº„Éâ„ÅÆÁµêÊûú„ÇíÈÄÅ‰ø°ÔºàÂãùËÄÖ„ÅÆ„Çπ„Ç≥„Ç¢„ÇíË®òÈå≤Ôºâ
  const winnerScore = Math.max(p1.score, p2.score);
  if (winnerScore > 0) {
    const winner = p1.score >= p2.score ? p1 : p2;
    const winnerAcc = winner.attempts > 0 ? Math.round((winner.correct / winner.attempts) * 100) : 0;
    const winnerAlt = getStarBonus(getStarRating(winnerAcc));
    sendResultToTrail(winnerScore, winnerAlt);
  }
}

function battleGoHome() {
  goHome();
}

// ===================== BG =====================
(function(){
  const c=document.getElementById('bgParticles');const colors=['#d4a654','#8b5e3c','#f0c040','#c8a060','#6b3a1f'];
  for(let i=0;i<18;i++){const p=document.createElement('div');p.className='bg-particle';const size=4+Math.random()*18;
  p.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;width:${size}px;height:${size}px;background:${pickRandom(colors)};animation-delay:${Math.random()*5}s;animation-duration:${5+Math.random()*8}s;`;c.appendChild(p);}
})();
</script>
</body>
</html>
